<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      lang="en" xml:lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Ocean Eddies Web Viewer Notes</title>
  <style type="text/css">
    p.image-flow { page-break-inside: avoid; }
    p.image-flow object, p.image-flow img { vertical-align: top; }
    /* TODO: Put margins in images, not HTML page.  */
  </style>
</head>
<body>

<h1>Ocean Eddies Web Viewer Notes</h1>

<h2><a name="contents" id="contents">Contents</a></h2>

<ul>
  <li>
    <a href="#intro">Introduction</a>
    <ul>
      <li><a href="#intro_interact">Interactivity Basis</a></li>
      <li><a href="#intro_graph_render">Graphics Rendering</a></li>
      <li><a href="#intro_min_req">Minimum Browser Requirements</a></li>
      <li><a href="#intro_ftr_missing">Features not available when
      only minimum requirements are met</a></li>
      <li><a href="#intro_max_req">Maximum Useful Browser
      Requirements</a></li>
      <li><a href="#intro_old_support">Why bother supporting older
      browsers?</a></li>
      <li><a href="#intro_core_js_lib">Core JavaScript
      Libraries</a></li>
    </ul>
  </li>
  <li><a href="#goals">
      Goals and Progress Center</a></li>
  <li><a href="#icosahedron">
      Mathematically Build an Icosahedron</a></li>
  <li><a href="#projections">
      Projections</a></li>
  <li><a href="#draw_graticule">
      Drawing an Orthographic Graticule as Ellipses</a></li>
  <li><a href="#tracks_format">
      Optimized Eddy Tracks Storage Format</a></li>
  <li><a href="#imp_center">
      Implementation Center</a></li>
  <li><a href="#comp_center">
      Compatibility Center</a></li>
  <li><a href="#perf_center">
      Performance Center</a></li>
  <li><a href="#scratch_notes">
      Scratch Style Notes</a></li>
</ul>

<hr />
<!-- ________________________________________ -->

<h2><a name="intro" id="intro">
    Introduction</a></h2>

<p>The goal of the Ocean Eddies Web Viewer is to make the data from
the Ocean Eddies project more accessible to a wider audience.  The
Eddy Web Viewer should be very well designed so that all of the
following hold true:</p>

<ol>
  <li>The data can be accessed from a large variety of browsers, all
  the way down to Firefox 3.6, Internet Explorer 6, and versions of
  Safari from 2004, provided that adding such support does not require
  an unreasonable amount of effort.</li>
  <li>The viewer will be easy to use.</li>
  <li>The viewer will have an attractive look, feel, and feature set.
  Think Google Earth: the viewer will have both 2D and 3D map views.
  However, unlike Google Earth, you do not need to install a browser
  plugin to use the viewer.</li>
  <li>The viewer has to be fast and responsive: high resolution images
  should be broken up into tiles and loaded individually.</li>
</ol>

<p>These are some links to general resources for this project.</p>

<ul>
  <li>Main Ocean Eddies website:
    <a href="http://climatechange.cs.umn.edu/eddies/">
      http://climatechange.cs.umn.edu/eddies/</a></li>
  <li>Main Ocean Eddies Github:
    <a href="https://github.com/jfaghm/OceanEddies">
      https://github.com/jfaghm/OceanEddies</a></li>
  <li>Example 2D interactive wind map that works okay with older
    browsers: <a href="http://hint.fm/wind/">http://hint.fm/wind/</a></li>
  <li>Example interactive map that has more features, but is somewhat
  slow and doesn't work well with older browsers:
    <a href="http://earth.nullschool.net/">
      http://earth.nullschool.net/</a></li>
  <li>Good public domain dataset for images of the Earth:
    <a href="http://www.naturalearthdata.com/">
      http://www.naturalearthdata.com/</a></li>
</ul>

<h3><a name="intro_interact" id="intro_interact">Interactivity
Basis</a></h3>

<p>The primary technology that will be used to provide interactive
user interface elements within the web browser will be using
JavaScript to manipulate Dynamic HTML.  Interactive display of
graphics will be handled by a variety of different technologies.</p>

<p>For 2D vector graphics, there are four choices for display, listed
in order from least compatibility issues to most compatibility
issues:</p>

<ol>
  <li>SVG</li>
  <li>HTML Canvas</li>
  <li>VML (Internet Explorer Only)</li>
  <li>WebGL</li>
</ol>

<p>3D graphics can be achieved through either manual projection before
rendering 2D vector graphics, per-pixel ray tracing of textures onto
an HTML Canvas, or through WebGL GLSL pixel shaders.</p>

<h3><a name="intro_graph_render" id="intro_graph_render">
    Graphics Rendering</a></h3>

<p>Interactive graphics rendering for the sea surface height and
eddies on the Earth poses a variety of design challenges from
compatibility to performance.</p>

<h4>Problem: Render the land masses of the Earth.</h4>

<p>Land details are not really important for the Eddy Web Viewer,
mostly so that you can see the nearby continents.  Thus, only outlines
of the land masses need to be rendered, although rendering textured
land masses isn't that much harder.</p>

<h4>Problem: Render the eddy paths and boundaries.</h4>

<p>Eddy paths and boundaries need to be updated dynamically when the
user changes display settings.  Rendering vector graphics on demand is
probably a better idea than storing the prerendered paths in a
backbuffer.</p>

<h4>Problem: Rendering lots of vector graphics can be slow.</h4>

<p>Solution: Have the default settings only show a few vector
graphics.  Only render what is within the viewing bounds.  Decrease
vector graphics density at low zoom levels.  Draw less geometry during
globe rotation and zoom.</p>

<h4>Problem: Old JavaScript interpreters can be slow.</h4>

<p>Solution: Careful testing and benchmarking of the JavaScript in the
essential loop paths.  Preliminary testing has shown that handwritten
JavaScript, as opposed to JavaScript from libraries such as D3.js, can
have sufficient performance even on old JavaScript interpreters.</p>

<h4>Problem: Render the sea surface heights of the Earth on a 2D
map.</h4>

<p>Solution: HTML Canvas rendering JavaScript should yield sufficient
performance.  Otherwise, the image maps can be pre-generated on the
server and downloaded by the browser.  Notably, modern versions of
Internet Explorer have a slower Canvas rendering performance than
other modern browsers.</p>

<h4>Problem: Downloading large datasets can be slow.</h4>

<p>Solution: Break up large images into tiles that are loaded one at a
time and combined on the local computer.  Break up large numeric
datasets into multiple files and prioritize loading of high resolution
data at the position that is currently visible to the user.</p>

<h4>Problem: Render an orthgraphic projection of the Earth as a
globe.</h4>

<p>Solution: HTML Canvas provides sufficient performance for this
task.  For GPU-enabled computers, a WebGL GLSL pixel shader can be
used for even higher performance.</p>

<h4>Problem: Internet Explorer 6 does not support the HTML
Canvas.</h4>

<p>The ExplorerCanvas JavaScript library can be used as a
compatibility wrapper to emulate an HTML Canvas by using VML.
However, ExplorerCanvas cannot emulate getImageData() and
putImageData(), so 3D texture mapping will have to be disabled when
using ExplorerCanvas.</p>

<h4>Problem: There is a lot of variation in the features that browsers
support.</h4>

<p>Solution: Maintain a browser feature test suite that individually
tests each component feature in the browser.</p>

<h3><a name="intro_min_req" id="intro_min_req">
    Minimum Browser Requirements</a></h3>

<ul>
  <li>JavaScript 1.5 interpreter</li>
  <li>HTML 4.01</li>
  <li>Web developers: XHTML 1.0</li>
  <li>CSS 2.1 (CSS 1 support may be added later)</li>
  <li>Raster image display</li>
  <li>Dynamic vector graphics rendering, either SVG, VML, or HTML
  Canvas</li>
</ul>

<h3><a name="intro_ftr_missing" id="intro_ftr_missing">
    Features not available when only minimum requirements are met</a></h3>

<ul>
  <li>3D Textured Earth View</li>
  <li>Local download and processing of Sea Surface Height data</li>
</ul>

<p>In order to support browsers that cannot perform tasks like
downloading and rendering the Sea Surface Height directly, the server
will also need to meet a minimum requirement of providing batch
processing of any new data to generate the necessary image maps.</p>

<h3><a name="intro_max_req" id="intro_max_req">
    Maximum Useful Browser Requirements</a></h3>

<p>A browser/computer system that exceeds these requirements will have
no additional advantages when using the Eddy Web Viewer.</p>

<ul>
  <li>High performance JavaScript interpreter</li>
  <li>HTML 5</li>
  <li>CSS 2.1</li>
  <li>Raster image display</li>
  <li>Vector graphics rendering, preferably SVG</li>
  <li>Full support for HTML 5 Canvas.  Support for getImageData() and
  putImageData() raster operations on HTML Canvas.</li>
  <li>WebGL, GPGPU hardware acceleration</li>
</ul>

<h3><a name="intro_old_support" id="intro_old_support">
    Why bother supporting older browsers?</a></h3>

<p>The thing about communication services is they involve sending
messages to other people's devices, and because those devices
are <em>their</em> devices, not yours, you generally cannot force an
immediate change to the device.  Because of various restrictions such
as IT department policies where the actual owner of the device is not
the user of the device, if you require them to change their hardware
or software to access your site, you're probably going to just end up
chasing away a potential user.  There is really a "take it or leave
it" ethic if you want to get the message across with communication
technologies.</p>

<h3><a name="intro_core_js_lib" id="intro_core_js_lib">
    Core JavaScript Libraries</a></h3>

<p>These are a variety of JavaScript libraries or libraries that
process JavaScript code that are likely to prove useful for the
implementation of the Eddy Web Viewer.</p>

<ul>
  <li>D3.js &mdash; data-driven document library, works with both SVG and
  HTML Canvas rendering backends<br />
  <a href="http://d3js.org/">http://d3js.org/</a></li>
  <li>ExplorerCanvas &mdash; HTML Canvas compatibility library for old
  versions of Internet Explorer (IE6)<br />
  <a href="http://excanvas.sourceforge.net/">
    http://excanvas.sourceforge.net/</a></li>
  <li>Three.js &mdash; 3D rendering helper library, works with both HTML 2D
  Canvas and WebGL 3D Canvas backends<br />
  <a href="http://threejs.org/">http://threejs.org/</a></li>
  <li>jsdoc3 &mdash; Documentation extractor for Doxygen-style
  documentation comments<br />
  <a href="https://github.com/jsdoc3/jsdoc">
    https://github.com/jsdoc3/jsdoc</a></li>
  <li>QUnit, a web JavaScript testing framework<br />
  <a href="http://qunitjs.com/">http://qunitjs.com/</a></li>
</ul>

<hr />
<!-- ________________________________________ -->

<h2><a name="goals" id="goals">
    Goals and Progress Center</a></h2>

<p>Future goals:</p>

<ul>
  <li>Server side data generation</li>
  <li>Icosahedron isosphere mesh equal angle subdivision (used only
  for native non-web viewer running on older graphics hardware with a
  fixed function pipeline)</li>
  <li>Transforming lat/lon for additional map projections.</li>
  <li>Add support for WebGL hardware accelerated rendering.</li>
  <li>Encode the SSH as a compressed video.</li>
</ul>

<p>Work in progress:</p>

<ul>
  <li>This info document</li>
  <li>Improve the organization the current code base.</li>
  <li>Improve the memory efficiency of the current code base.</li>
</ul>

<p>Completed goals:</p>

<ul>
  <li>Overview of the project and overarching organizing
  notes/documentation.</li>
  <li>Initial working implementation of the eddy web viewer.</li>
  <li>Transforming lat/lon for essential map projections.</li>
  <li>Built the CSS user interface.</li>
  <li>Connected the CSS UI to the current code base.</li>
  <li>Built and connected the improved slim CSS UI.</li>
  <li>Read and visualized large scale data in the web viewer.</li>
  <li>Browser feature test suite</li>
</ul>

<hr />
<!-- ________________________________________ -->

<h2><a name="icosahedron" id="icosahedron">
    Mathematically Build an Icosahedron</a></h2>

<p class="image-flow">
<object type="image/svg+xml" data="pentagon.svg"
	width="226" height="226">
  <img src="pentagon.png" alt="Pentagon construction."
       width="226" height="226" />
</object>

<object type="image/svg+xml" data="elevation.svg"
	width="226" height="226">
  <img src="elevation.png" alt="&quot;Top hat&quot; construction."
       width="226" height="226" />
</object>

<object type="image/svg+xml" data="topview.svg"
	width="226" height="226">
  <img src="topview.png" alt="Flattened top view."
       width="226" height="226" />
</object>

<object type="image/svg+xml" data="sideview.svg"
	width="226" height="226">
  <img src="sideview.png" alt="Side view construction."
       width="226" height="226" />
</object>
</p>

<h3>Instructions</h3>

<ol>
  <li>Create a pentagon by plotting 5 points on a circle, each spaced
  by 72 degrees.  Each vertex should be one unit distance from the
  center.  Connect the points to form the pentagon.</li>

  <li>Pick one edge of the pentagon.  Draw two lines from the center
  of the pentagon to each vertex of the chosen edge.  Draw a line from
  the center of the pentagon to the median of the edge.  Note that
  this forms a bisected isosceles triangle, which means (a) the two
  halves are right triangles, (b) the interior angle of each right
  triangle at the center of the pentagon is exactly 36 degrees, and
  (c) trigonometry can be used to determine the length of the chosen
  edge of the pentagon.</li>

  <li>Use trigonometry to determine the length of the chosen edge of
  the pentagon:<br />
  sin(36&deg;) &times; 2 = 1.17557050458</li>

  <li>Use trigonometry to determine the length of the line that
  bisects the chosen edge:<br />
  cos(36&deg;) = 0.809016994375</li>

  <li>Determine the additional length needed to extend the bisecting
  line from the chosen edge of the pentagon to the circumference of
  the circle:<br />
  1 - cos(36&deg;) = 0.190983005625</li>

  <li>Using trigonometry, determine the altitude that the center
  vertex of the pentagon should be elevated to form the "top" five
  equilateral triangles in the icosahedron:<br />
  sin(acos(1/1.17557050458)) &times; 1.17557050458 = 0.618033988739
  </li>

  <li>The "bottom hat" of the icosahedron should be identical to the
  "top hat", except that it is rotated 36 degrees from the orientation
  of the "top hat" and points down rather than up.</li>

  <li>The two "hats" will be connected with a series of equilateral
  triangles.  Each triangle will have one of its edges connect to the
  "top hat" and the opposite vertex connect to the "bottom hat".  Each
  such triangle will be tilted at an angle such that when looking at
  the icosahedron flattened from above, the X-Y planar distance
  between the median of the edge on one hat and the vertex on the
  other will be equal to the distance calculated in step 5.  With this
  information, a right triangle can be formed that extends
  horizontally out by the distance from step 5 and has a hypotenuse
  (running along the length of one of the new triangles to be added)
  equal to the length from step 4.  Trigonometry can then be used to
  calculate the vertical Z-axis distance between the rims of the
  hats: <br />
  cos(asin(0.190983005625/0.809016994375)) &times; 0.809016994375 =
    0.786151377757</li>

  <li>Center and scale the vertices so that each vertex is one unit
  distance from the origin of the coordinate system.</li>

  <li>Skin the faces on the calculated vertices to create the complete
  3D model of the icosahedron.</li>
</ol>

<hr />
<!-- ________________________________________ -->

<h2><a name="projections" id="projections">
    Projections</a></h2>

<p>The primary metrics used to indicate the positions on the Earth in
the eddies dataset are latitude and longitude.  In order to
interoperate this data with other data such as maps of the Earth and
rendering on screen, <em>projection methods</em> are needed.  The only
logic needed by the eddy web viewer for projections are two abstract
functions for each projection class: a <code>project()</code> method
and an <code>unproject()</code> method.  <em>Projection</em> is
defined as translating a latitude and a longitude into a Y and X
coordinate, and unprojection is the reverse operation.</p>

<h3>Map Projections</h3>

<p>Some datasets of the Earth, such as images of the land masses, are
often be stored in 2D image-based formats.  The following summaries of
common map projections are useful to know when dealing with such
images:</p>

<ul>
  <li><strong>Equirectangular projection:</strong> Simply maps
  latitude angles linearly along the Y-axis of the image and longitude
  angles linearly along the X-axis of the image.</li>
  <li><strong>Mercator projection:</strong> A cylindrical projection
  that stretches the map vertically at high and low latitudes in order
  to preserve projected angles (a conformal map).<br /> 
  X-coordinates map linearly to longitudes.<br />
  Y-coordinate to latitude mapping: y = R ln [ tan(&pi;/4 + &phi;/2) ]
  (R = radius = 1)<br />
  Latitude to y-coordinate mapping: &phi; = 2 atan[exp(y/R)] - &pi;/2
  (R = radius = 1)<br />
  <a href="http://en.wikipedia.org/wiki/Mercator_projection">
    http://en.wikipedia.org/wiki/Mercator_projection</a></li>
</ul>

<h3>3D Rendering Projections</h3>

<p>First of all, what factor distinguishes a 3D projection from a 2D
projection?  For the purposes of this application, it is basically the
need to carry around three of some kind of position variables in the
projection/unprojection equations.  Tilting the pole of the globe
before projection computations basically requires three-dimensional
mathematics in the intermediate equations.</p>

<p>Raytrace rendering a 3D view of the Earth is less trivial than one
would think at first.  The process of backtracing from screen pixels
to a a map pixel is a multistep process.</p>

<p class="image-flow">
<object type="image/svg+xml" data="orthographic.svg"
	width="202" height="142">
  <img src="orthographic.png" alt="Orthographic projection diagram."
       width="202" height="142" />
</object>

<object type="image/svg+xml" data="earth_rotate.svg"
	width="202" height="142">
  <img src="earth_rotate.png" alt="Point rotation diagram."
       width="202" height="142" />
</object>

<object type="image/svg+xml" data="angle_measure.svg"
	width="202" height="142">
  <img src="angle_measure.png" alt="Angle measurement diagram."
       width="202" height="142" />
</object>
</p>

<ol>
<li>The first step of the process is to backtrace from a screen pixel
to a point on a generic globe that the pixel maps to.  The main point
of this process is to determine a vector from the center of the globe
to this point.  To keep things simple, assume this vector will be
represented as a normalized 3-dimensional rectangular vector.  The
coordinate system at this step will be assumed to have the X-Y plane
be parallel with the screen, with the 3D origin (0, 0, 0) at the
center of the globe and quadrant I of the X-Y plane at the top-right
corner.  The camera will be located somewhere on the Z-axis, looking
down the negative direction toward the globe.</li>

<li>Once a vector describing the point on the globe in relation to the
center has been found, the vector should be inverse rotated by the
current rotation of the Earth to generate a vector that describes a
position on the Earth.  It is critical that the pole tilt
transformation is the independent transformation and the longitudinal
rotation transformation is the dependent transformation.</li>

<li>Now it is possible to determine the latitude and longitude of the
point.  The longitude can be determined by using <code>atan2()</code>
on a normalized vector from the X and Z coordinates, and the latitude
can be determined by using <code>sin()</code> on the Y
coordinate.</li>
</ol>

<p>Projection rendering vector geometry is basically the reverse
process, except that there is one additional step: after transforming
the geometry, determine if the projected point is visible or not.  If
it is not visible, don't render it.</p>

<p>The specific mathematics used for backtracing a ray or projecting a
vector in step 1 depends on whether perspective is used for rendering
or not.</p>

<h4 style="clear: left">Orthographic Projection</h4>

<p class="image-flow" style="float: left">
<object type="image/svg+xml" data="orthographic.svg"
	width="202" height="142">
  <img src="orthographic.png" alt="Orthographic projection diagram."
       width="202" height="142" />
</object>
</p>

<p>Orthographic projection is simply a flattening of 3D geometry onto
a 2D plane of a sufficiently large size to contain the 3D geometry.
To obtain the necessary rectangular vector for step 1 above, the X and
Y offsets from the center of the globe are simply the same as the X
and Y offsets from the center of the projection plane, and the Z
offset along the direction of projection can be obtained via
<code>sin(acos(sqrt(x^2 + y^2)))</code>.</p>

<h4 style="clear: left">Perspective Projection</h4>

<p class="image-flow">
<object type="image/svg+xml" data="perspective.svg"
	width="244" height="142">
  <img src="perspective.png" alt="Perspective projection diagram."
       width="244" height="142" />
</object>

<object type="image/svg+xml" data="persp_graph2d.svg"
	width="202" height="202">
  <img src="persp_graph2d.png" alt="2D perspective graph."
       width="202" height="202" />
</object>
</p>

<p>Perspective projection operates by tracing straight lines from an
object through the screen to the <em>focal point</em>, the point
behind the screen where all lines converge.  For rendering the Earth,
it is primarily used for aesthetic purposes to make the rendered Earth
look like it does from geosynchronous orbit.  To get a physically
accurate rendering of how the Earth looks from geosynchronous orbit,
these two parameters are essential: the mean radius of the Earth
(6371.0 km) and the altitude of geosynchronous orbit (35,786 km).</p>

<p>Given a pixel screen coordinate, it is somewhat more difficult to
solve for the point on the generic globe with perspective projection
than is the case with orthographic projection.  However, by
simplifying the problem into two 2D cases, one for the X coordinate
and the other for the Y coordinate, it can be easily seen that this is
only a problem of solving for the intersection between a line and a
hemicircle.  A system of two equations in two unknowns can be setup
and the quadratic formula can be used on the resulting equation.
Since only a hemicircle is considered, only one of the two solutions
of the quadratic formula needs to be considered.  The mathematical
setup for the solution is written below:</p>

<!-- BAD BAD!  Many old browsers have no way of figuring out the
actual height of an embedded HTML object, so we must code in a
reasonable height manually.  Maybe there is some browser setting that
I don't know about that limits the maximum intrinsic height of
embedded objects. -->
<p style="text-align: center">
<object id="persp_math1" type="application/xhtml+xml" data="persp_math1.xhtml"
	width="100%" height="941">
<img src="persp_math1.png" alt="[complicated math that spans multiple lines,
 don't even try to read this without raster image display]"
     width="607" height="941" />
</object>
</p>

<script type="text/javascript">
/* Adjust the height of the object container to be the actual height
   of its content, but only after the document has finished loading
   AND MathJax processing has finished.  */

window.setTimeout(function setupPM1() {
  var persp_math1 = document.getElementById('persp_math1');
  persp_math1.height = 300;
  var pm1height = persp_math1.contentDocument.documentElement.scrollHeight;
  persp_math1.height = pm1height;
}, 10000);

/* TODO: We need to somehow hook the following script in the nested
   document structure:

    MathJax.Hub.Register.StartupHook("End", function () {
      // alert("The TeX input jax is loaded and ready!");
      // Setup the height of the external container.
    });

*/
</script>

<p>Once the "Y" coordinate, which is actually the Z coordinate, of the
near point is found, the near point's X coordinate can be found simply
by substituting the "Y" coordinate into the ray equation (equation of
a line) and solving for the X coordinate.  A similar solution can be
derived for the real Y coordinates by substituting the relevant
variables in the above solution.</p>

<p class="image-flow">
<object type="image/svg+xml" data="sphere_cross1.svg"
	width="202" height="101">
  <img src="sphere_cross1.png" alt="Cross section through equator of globe."
       width="202" height="101" />
</object>

<object type="image/svg+xml" data="sphere_cross2.svg"
	width="202" height="101">
  <img src="sphere_cross2.png" alt="Tilted cross section through globe."
       width="202" height="101" />
</object>
</p>

<p>Unfortunately, the above simplification of considering the X and Y
coordinates separately is incorrect.  Look at it this way: Suppose you
have a point on the Z axis located a distance "r + d" away from the
center of a sphere.  Try drawing a plane through the equator of the
sphere and the point on the Z axis.  You'll get a circular
cross-section with radius "r" just as expected from the equations
above.  Now suppose you tilt that plane around the Y axis, making sure
the plane still passes through the distanced point on the Z axis.  The
cross-section of the sphere that lies on the plane will end up having
a radius smaller than "r".  Thus, the above algorithm cannot be used
for X and Y independently, since that computational method is
flawed.</p>

<p>Luckily, it turns out that the solution with a 3D sphere equation
is not that much more difficult.  Starting with the equation of a
sphere and two equations for X and Y screen coordinates, the Z
coordinate on the sphere is solved for, which gives the quadratic
formula.  Only the "near" solution needs to be considered, since the
"far" solution is occluded by the front of the sphere.  After the Z
coordinate on the sphere is found, the X and Y coordinates of the
point on the sphere can be trivially found using the X and Y ray
equations.</p>

<p style="text-align: center">
<object id="persp_math2" type="application/xhtml+xml" data="persp_math2.xhtml"
	width="100%" height="617">
<img src="persp_math2.png" alt="[complicated math that spans multiple lines,
 don't even try to read this without raster image display]"
     width="540" height="617" />
</object>
</p>

<script type="text/javascript">
/* Adjust the height of the object container to be the actual height
   of its content, but only after the document has finished loading
   AND MathJax processing has finished.  */

window.setTimeout(function setupPM2() {
  var persp_math2 = document.getElementById('persp_math2');
  persp_math2.height = 300;
  var pm2height = persp_math2.contentDocument.documentElement.scrollHeight;
  persp_math2.height = pm2height;
}, 10000);

/* TODO: We need to somehow hook the following script in the nested
   document structure:

    MathJax.Hub.Register.StartupHook("End", function () {
      // alert("The TeX input jax is loaded and ready!");
      // Setup the height of the external container.
    });

*/
</script>

<h3>Display Considerations</h3>

<p>All of the above algorithms assume that there is no rotation along
the axis that points directly away from the viewer.  Any such rotation
along this axis would simply result in the 2D image onscreen appearing
at a different rotation.  Thus, it is not necessary to factor this
rotation into these calculations that are concerned with the more
difficult math.  If there is any rotation along this axis, then an
inverse rotation can simply be used to preprocess the screen
coordinate before backtracing it to the globe.</p>

<h3>Gracefully switch between different projections</h3>

<p>When switching between different projections, it is convenient to
have the viewer display the Earth in the new projection centered at
the same latitude and longitude, along with a scale factor such that
the new view is as similar as possible to the old view.  Maintaining
the same latitude and longitude at center is easy.  The scale factor,
however, requires some more forethought.</p>

<p>How do you synchronize the scale factor between orthographic and
equirectangular projection?  Think of things this way: pretend that to
switch from orthographic to equirectangular projection, you just cut a
slit in the globe across the international date line and unroll the
Earth's surface equator-wise into a flat map.  This makes
synchronizing the scale factor fairly easy: the length of the
equirectangular map should equal 2&pi;r, r being the radius of the
orthographic sphere.  This scale factor synchronization mechanism can
be used for all cylindrical projections with ease.  Non-cylindrical
projections and projections with interruptions will require a more
complicated scale factor synchronization mechanism.</p>

<p>How do you synchronize orthographic and perspective projections?
The trick to synchronizing with perspective projection is to treat the
altitude as a constant and use the field of view as a compatible
replacement for the scale factor.  When the globe fills the entire
screen, the scale factor of a compatible orthographic projection should
be such that the degrees of latitude and longitude contained within
the view are held nearly constant when switching back and forth.</p>

<p>When the intersection of the furthest visible rays with the globe
is NaN (the visible globe is smaller than the size of the viewport),
then the scale factor of a compatible orthographic projection should
be adjusted so that the amount of the earth visible in the perspective
projection appears at the same size in the orthographic projection.
When viewing the Earth at a very large field of view and a very low
altitude, the visible disc of the Earth will be less than a full
hemisphere.  Thus, switching to orthographic projection will result in
a larger amount of the Earth appearing around what was visible in
perspective projection.</p>

<p>Now for the equations.  It turns out that these equations are just
as effective when done in 2D with a ray and a circle, so that is how
the solutions will be reached.</p>

<p>First, when the globe fills the entire screen, you can just use the
2D raytracing equations as solved for above to determine the range of
longitudes that are visible.  Simply trace a ray that corresponds to
the edge of the field of view.</p>

<p>Next, when there is spare visible space around the globe, here's
how to find the point on the globe that is the furthest visible point
in perspective projection.  Think about drawing a line from the focal
point to the globe such that the point intersected on the globe is
tangent to the surface.  Now think about drawing a line from the
intersected point to the core of the Earth.  The two lines should be
perpendicular, or in other words, the product of the slopes should
equal -1.  Now for the solution:</p>

<pre>
(x_g, y_g) = point on surface of globe
(0, y_f) = focal point

(y_g - y_f) / (x_g - 0) * y_g / x_g  = -1
(y_g^2 - y_f * y_g) / x_g^2  = -1
y_g^2 - y_f * y_g + x_g^2  = 0

x_g^2 + y_g^2 = 1
x_g^2 = 1 - y_g^2

y_g^2 - y_f * y_g + 1 - y_g^2  = 0
-y_f * y_g + 1 = 0
y_g = 1 / y_f</pre>

<p>One the y coordinate of the point on the globe has been found, the
longitudinal range can be trivially derived.</p>

<hr />
<!-- ________________________________________ -->

<h2><a name="draw_graticule" id="draw_graticule">
    Drawing an Orthographic Graticule as Ellipses</a></h2>

<p>Intuitively, it seems it should be possible to draw an orthographic
graticule by simply drawing a series of ellipses, but is
it <em>really</em> possible?  If so, then how do you do it?</p>

<p>Yes, it is really possible.  Although there's a
<a href="http://commons.wikimedia.org/wiki/File:Sphere_wireframe.svg">
C++ program that generates a wireframe graticule image from ellipses
on Wikimedia commons</a>, the C++ program comes with the following
warning: "The expressions in this code are not proven to be correct.
Hence this code probably contains lots of bugs.  Be aware!"  The
following explanations describe how to draw an orthographic graticule
as a series of ellipses in a mathematically sound way.</p>

<p>The following explanations assume that you have a reasonable
background knowledge of rotation transformations.  Just to be clear,
though, the following equations briefly explain how to rotate a point
by "&theta;" degrees (or radians):</p>

<ul>
  <li><code>x_new = x * cos(&theta;) - y * sin(&theta;)</code></li>
  <li><code>y_new = y * cos(&theta;) + x * sin(&theta;)</code></li>
</ul>

<p>Intuitively, if the original point has one of the x or y
coordinates set to zero such as (1, 0) or (0, 1), the equations
simplify to be a coordinate multiplied by only a factor
of <code>sin(&theta;)</code> or <code>cos(&theta;)</code>.  The
concepts underlying rotation transformations are very important in
understanding conversions between polar coordinates and rectangular
coordinates.  You'll have to be vigilant in recognizing whether
a <code>sin()</code> or <code>cos()</code> function is used as a
rotation transformation, a polar coordinate conversion, or both.  For
example, a special case of the above equations that specifies the
parametric equations of a circle (or conversion from polar to
rectangular coordinates) is as follows:</p>

<ul>
  <li><code>let r = x_0 = 1</code></li>
  <li><code>x = r * cos(&theta;)</code></li>
  <li><code>y = r * sin(&theta;)</code></li>
</ul>

<p>Now that review matters are out of the way, here's the solution.
First, start out simple.  Assume a globe with a radius of unit length
(1).  Looking at a globe equator-on-center, parallels are straight
lines and meridians are ellipses.  This can be drawn with ease.  For
the latitudes, just use <code>sin(latitude)</code> to determine the Y
position to draw the parallels and
<code>2 * cos(latitude)</code> to determine the length of the line.
For the meridians, just use <code>sin(longitude)</code> to determine
the X-axis radius of the meridians and "1" as the Y-axis radius,
assuming that the rotation of the globe around its pole is such that
the prime meridian is at the center of the viewport.  Note that
drawing a full ellipse draws both the positive and negative meridian
at the same time.  To finish off the drawing and make it look
complete, a circle of radius 1 centered at the origin should be drawn
to enclose all the parallels and meridians.</p>

<p>Then, looking at the globe pole-on-center, parallels are concentric
circles around the pole, and longitudinal lines are straight lines
intersecting at the pole.  The radius of the parallel circles can be
found by using <code>cos(latitude)</code>, and the meridian lines are
simply rays spaced by an equal rotational distance, all of which
extend from the pole to the outermost visible parallel by a length of
one unit.</p>

<p>In both of the above cases, rotation around the pole is trivial:
just draw the meridians at a different starting angle.  The parallels
will not change based off of the rotation around the pole.</p>

<p>The next trick is to figure out how to render the graticule
orthographically at globe tilts in between these extremes.  First,
think about drawing a line to connect the north and south poles on the
globe.  When tilting the globe from equator-on-center to
pole-on-center, the 2D distance between the north and south pole
decreases from the diameter of the sphere to zero, exactly by
the <code>cos()</code> function as used for computing rotations.  This
makes mathematical sense, since tilting the globe is simply a rotation
transformation.</p>

<p>Now think about the parallels.</p>

<ul>
  <li>When looking at the globe equator-on-center, each parallel
  intersects a position on the line connecting the poles.  The
  intersected position indicates the parallel's height along the pole
  axis, of course.</li>
  <li>When the globe is tilted, the parallels go from being rendered
  as simple lines to ellipses, and when the globe is tilted by 90
  degrees, the parallels appear as circles.  The centers of all of
  these circles/lines always lie somewhere on the pole line.  Since
  rotating a line in orthographic projection squashes every point on
  the line uniformly by a linear factor, the centers of the circles
  can easily be computed by multiplying their height along the pole
  axis by the 2D length of the orthographically-projected pole.</li>
  <li>The width of the parallel ellipses is always the same.  Because
  the axis of the ellipses pertaining to the width of the ellipses
  always runs along the tilt axis, tilting the globe never
  mathematically changes the width of the parallel ellipses.</li>
  <li>The next challenge in drawing the parallels is determining what
  the vertical height that the parallel ellipses must be.  However,
  this is simply correlated with the rotational tilt of the
  earth: <code>sin(tilt)</code> succintly describes the factor to
  multiply the height by.  When the tilt is 90 degrees, the parallels
  are rendered as circles (<code>sin(tilt)</code> equals 1), and when
  the tilt is 0 degrees, the parallels are rendered as lines
  (<code>sin(tilt)</code> equals 0).</li>
</ul>

<p>Now think about the meridians.</p>

<ul>
  <li>When tilting the globe from equator-on-center to pole-on-center,
  the meridians get progressively squashed into straight lines.  Not
  only do they get progressively squashed, the 2D vertical extent of
  the squashed shapes also increases from zero to a maximum when
  looking at the globe pole-on-center.</li>
  <li>The lines seen when looking at the globe pole-on-center can be
  thought of as vertically squashed and sheared ellipses.  When
  looking at the globe equator-on-center, the shear factor is zero and
  the squash factor is one.</li>
  <li>At this point, one possible way to draw the meridians is to 1)
  squash the meridian circles horizontally and vertically then 2)
  vertically shear the ellipse to get the target ellipse to draw.</li>
  <li>Think back to rendering meridians equator-on-center.
  <code>sin(longitude)</code> defines the horizontal squash factor on
  a circle needed to render the meridian correctly.  Adding globe tilt
  into consideration, the vertical squash factor is simply
  <code>cos(tilt)</code>.</li>
  <li>The equation that describes the vertical shear transformation is
  as follows:
  <code>y_new = y + x * shear_factor</code>.</li>
  <li>First, the shear factor is dictated by the squash factor of the
  <em>parallel</em> ellipses: the shear factor should be set such
  that <code>sin(tilt)</code> defines the vertical squash factor on
  the line running through the major axis of the ellipse.  This is the
  reason why this makes mathematical sense: As was explained with
  transformation of the pole line above, rotation changes the vertical
  scale factor, which is defined by <code>sin(tilt)</code>, but
  horizontal distances remain unchanged.  <em>Shearing</em> is used
  instead of simple scaling so that the maximum Y coordinate of the
  line running through the major axis of the ellipse can be adjusted
  to the expected value.  Since the circle pre-squashed in the
  horizontal direction, setting the shear factor is as follows:<br />
  <pre>
  shear_factor =
  /* Y extent scaling factor: */ sin(tilt) *
  /* Y extent of major axis when tilt = 90: */ cos(longitude) /
  /* X extent of major axis: */ sin(longitude)</pre></li>
  <li>Finally, one optimization that can be performed is to apply the
  horizontal squash transformation <em>after</em> the shear
  transformation.  This drops the X extent correctional factor from
  the shear factor equation as follows: <code>shear_factor = sin(tilt) *
  cos(longitude)</code>.  It also avoids a potential divide-by-zero.</li>
  <li>Consider an alternate process to reaching the solution.  Instead
  of starting with a view of the globe equator-on-center, think about
  starting with a view of the globe pole-on-center.  Approaching the
  problem from this perspective, the first problem solving steps would
  be to draw the lines as appearing from above simply as straight
  lines on the equatorial plane.  When viewing such a globe
  equator-on-center, all of the lines should lie flat and be occluded
  by the equatorial line.  By simply using only the line that
  corresponds to the major axis of the elliptical process above, this
  effect can easily be achieved.  Let's overview how this process
  works for this simplified case:
    <ol>
      <li>Start by drawing a straight horizontal line of length 2,
      centered at the origin.</li>
      <li>Vertically shear this horizontal line with
      <code>shear_factor = sin(tilt) * cos(longitude)</code>.</li>
      <li>Horizontally squash the sheared line by
      <code>sin(longitude)</code>.</li>
    </ol>
  It should now be easily obvious that the last step to transition
  from the above partial meridian-drawing procedure to the full
  procedure is to start by drawing a circle with radius 1, then
  squashing the circle vertically as appropriate for the current tilt
  angle, then performing the last two shearing and squashing steps
  above verbatim.</li>
</ul>

<p>Although the above explanations provide a pretty good graticule
drawing method so far, there is still one problem: this method must
draw both the front side and the back side of the globe's graticule.
How do you clip the elliptical arcs that correspond to the back side
of the graticule?</p>

<p>Here's the overall strategy that will be used to approach this
problem: 1) Find a way to parameterize the great circle that divides
the front and back sides of the globe.  2) Use that equation to
determine points along the parallels and meridians that lie on this
boundary to divide the lines into front pieces and back pieces.</p>

<h3>Equation of a Great Circle in Polar Coordinates</h3>

<p>Start by thinking in 2D.  On a 2D orthographic projected globe,
draw a straight line that runs through the center of the image.  You
can see that the visual halves it divides the globe into are of equal
area.  You can also imagine that the line it slices through on the
invisible back side of the globe must be identical to the one on the
front side of the globe.  Thus, this line is effectively a great
circle, if only you could define it on the 3D globe rather than just
the 2D projection of it.</p>

<p>Lucky for you, you happen to have both the forward and reverse
projections for orthographic projection handy with you.  You can take
the equation of this 2D line and run it through the reverse
orthographic projection equations to get an equation that defines a
great circle line with a specific tilt angle.</p>

<pre>
lat = asin(y)
lon = asin(x / cos(lat))

y = m * x + b
angle = atan(m)
m = tan(angle)
b = 0

lat = asin(tan(angle) * x)
sin(lat) = tan(angle) * x
sin(lat) / tan(angle) = x

lon = asin(x / cos(lat))
sin(lon) = x / cos(lat)
sin(lon) * cos(lat) = x

sin(lat) / tan(angle) = sin(lon) * cos(lat)
sin(lat) / cos(lat) = sin(lon) * tan(angle)
tan(lat) / tan(angle) = sin(lon)
sin(lon) = tan(lat) / tan(angle)
lon = &plusmn;asin(tan(lat) / tan(angle))</pre>

<p>The following equations will be more useful.  Most great circles
cover all longitudes, but many great circles do not cover all
latitudes.</p>

<pre>
tan(lat) / tan(angle) = sin(lon)
tan(lat) = sin(lon) * tan(angle)
lat = atan(sin(lon) * tan(angle))</pre>

<p>The following reformulation of the above equation has the best
numeric stability:</p>

<pre>
tan(lat) = sin(lon) * sin(angle) / cos(angle)
lat = atan2(sin(lon) * sin(angle), cos(angle))</pre>

<p>Perfect!  When a line is steep longitude-wise, that means it's almost
a meridian, which means that it doesn't need as many samples on an
equirectangular map since it it almost just a vertical line.  In
between shallow and steep, a line gets a good number of samples.  The
<code>atan2()</code> function allows absolute extreme vertical to also
be handled gracefully.</p>

<p>Note that these equations always draw the great circle line such
that it intersects the equator at the prime
meridian.  <code>angle</code> defines the rotation around this point.
To shift the great circle pole away from the prime meridian, just add
or subtract the desired longitudinal amount to shift to the input
parameter of the equation as follows:<br />
<code>lat = atan2(sin(lon + lon_rot) * sin(angle), cos(angle))</code></p>

<p>For the equation of the great circle that bounds the visible side
of the globe, <code>lon_rot</code> should be the view's rotation
around the pole plus 90 degrees, and <code>angle</code> should be 90
degrees minus the tilt angle, if positive.  If the tilt angle is
negative, then the <code>angle</code> should be -90 degrees plus the
tilt angle.  Using the above equations, the longitude of a meridian
can be plugged in to determine the latitudes that intersect with the
edge of the visible globe.  Likewise, the latitude of a parallel can
be plugged in to determine the longitudes that intersect with the edge
of the visible globe; however, special handling must be done for tilts
of -90, 0, and 90 degrees.  Determining which segments are on the
front and back after the intersection computations is trivial: Pick a
point somewhere on the segment and test whether it is within the
visible range of latitudes or longitudes.</p>

<hr />
<!-- ________________________________________ -->

<h2><a name="tracks_format" id="tracks_format">
    Optimized Eddy Tracks Storage Format</a></h2>

<p>In the first version of the web viewer, the eddy tracks were stored
as a simple series of nested arrays in JSON format.  This was the
structure of the JSON files:</p>

<ol>
  <li>Top level: [ list of tracks ]</li>
  <li>track: [ list of eddies ]</li>
  <li>eddy: [ latitude, longitude, date_index, eddy_index ]</li>
  <li>Date indexes start from one, not zero.</li>
</ol>

<p>Unfortunately, this had many problems associated with it.</p>

<ul>
  <li>The variable length JSON fields made for a file that could not
  be accessed in random order.  The JSON file had to be read and
  parsed in its entirety.</li>
  <li>Optimized rendering is not possible without browser-side tree
  building.</li>
</ul>

<p>However, the advantage at the time was that the format was easy and
simple to put together.  Thus, it made it possible to push an alpha
version of the web viewer before the viewer was actually finished.</p>

<p>The easiest solution to the random access problem is to pad each
field out to be an equal byte length.  Storing the data in a binary
numeric format would help alleviate the burden on excess storage space
and download time.  However, it would also make for tremendously slow
data parsing on browsers that do not support the typed arrays
JavaScript extensions.</p>

<h3>Building the Tree</h3>

<p>For the tree building problem, the analysis is a bit more
complicated.  At a first glance, it seems that there are two
possibilities: quadtrees/octrees and kd-trees.  Quadtrees/octrees can
have O(1) lookup time, but kd-trees have O(log n) lookup time.  For
memory consumption, quadtrees/octrees consume O(n + b) memory (the
total memory consumed is the memory consumed from all the original
data points plus the bucketing structure of the quadtree/octree),
while kd-trees consume O(n) memory, exactly the same amount of memory
it takes to store the data points literally.  Between the two general
choices of quadtrees/octrees versus kd-trees, all hands are down for a
kd-tree.  Why?  Because JavaScript is a garbage-collected language,
any and all memory allocations are going to be considerably expensive.
All minimizations on memory consumption are likely to translate
directly to faster performance because of a twofold reason: 1) not as
much garbage will accumulate in the program's working set and 2) a
smaller overall working set will fit better in the CPU cache memory.
For low-memory devices, a smaller working set translates to dramatic
performance improvements, sometimes making the difference between
having a usable program versus not being able to run the program at
all.  Thus, even though kd-trees have longer lookup times, the lower
memory consumption is their big win, and the lookup time is well
justified at O(log n).</p>

<p>Now that a tree building algorithm has been picked, how should the
data be built into the tree?  The most natural choice would be to
build the eddies into the tree, since they are just points.  Each eddy
has a latitude, longitude, and date, so a three-dimensional kd-tree
can be built using these metrics.</p>

<p>However, this poses one problem: It would be nice to arrange the
data such that chronologically-early data points are downloaded first.
A kd-tree does not yield a perfect ordering in this regard.  The
solution to this problem starts with sorting eddies by date.  All
eddies on the same date will be grouped together.  Within each date
grouping, build the eddies into a 2D kd-tree based off of the latitude
and longitude.  Lookup time on this structure will be O(log(n) +
log(n)) = O(log n).  Thus, performance of a group of 2D kd-trees
sorted by date is identical to that of a 3D kd-tree, except that there
may be a different constant on the asymptotic runtime.</p>

<p>The kd-trees are stored as a binary-search style tree: The root
element is approximately in the middle of the array.</p>

<p>For efficient network transmission, the track connectivity
information is stored as a singly-linked list as follows.  Each eddy
has a "next" pointer that indicates the next eddy in the track.  If
the pointer points backwards, than that indicates that the current
eddy is the end of the track, and the "next" eddy is actually the
beginning of the track.  All "pointers" are actually stored as indexes
relative to the current eddy index, since this allows for smaller
integers with less digits.  Once the data have been downloaded, "prev"
pointers can be created and relative indexes can be converted to
absolute indexes.</p>

<h3>Rendering from the Tree</h3>

<p>To render from the eddy tracks data structure, start by picking the
kd-tree at the current date.  The next step is to do a kd-tree
traversal until the selected partition in the kd-tree is the smallest
possible partition that entirely surrounds the viewport rectangle.
This partition of the kd-tree corresponds to the potentially visibile
set of eddies to render at the current date.</p>

<p>Proceed by traversing the forward and reverse pointers to find the
eddies on the adjacent dates that are on the same tracks.  Once all
the visible eddies are found, draw lines to connect the eddies in the
visible tracks.</p>

<p>Unfortunately, there are a few problems with the above simplified
procedure:</p>

<ul>
  <li>Some of the eddies further forward or backward in time along the
  track may not be within the visible bounding box.  These points can
  be clipped if necessary.</li>
  <li>Suppose there is a track with an eddy on the current date, but
  not within the visible region.  Other eddies along the same track
  might cross through the visible region, but they won't end up
  getting rendered.  Perhaps the best way to solve this problem is to
  use track-level bounding boxes.</li>
  <li>Some track segments may be "oversized"; that is, both endpoints
  of the segment are outside of the visible bounding box, yet the
  segment crosses through the bounding box and thus should be visible.
  In addition to the above solution of using track-level bounding
  boxes, another solution would be to create a secondary tree that
  lists oversized lines that cross through lower levels of the
  kd-tree.</li>
</ul>

<p>Finally, one last option is to just avoid the entire optimized
rendering tree build process and just generate a random-access index
to prepend to the tracks data.  It will also be more convenient to
have the tracks stored in only one file or format.  I guess I could
use additional header data for that.</p>

<hr />
<!-- ________________________________________ -->

<h2><a name="imp_center" id="imp_center">
    Implementation Center</a></h2>

<p>This is where helpful notes pertaining to the implementation are
stored.  Some of these notes are only needed during the intermediate
development stages of the implementation.</p>

<p>Overall, the implementation of the web viewer is divided into three
main areas: the CSS user interface (GUI), the renderer, and data
I/O.</p>

<ul>
  <li>CSS User Interface</li>
  <li>Renderer</li>
  <li>Data I/O</li>
</ul>

<p>This design pattern (or a similar design pattern) is more often
called Model/View/Controller (MVC), but for the purposes of this code,
the names of the modules will be the names indicated above.</p>

<p>Since this is a web application rather than a traditional "native"
application, a few extra components are also necessary:</p>

<ul>
  <li>Browser-side browser compatibility layer</li>
  <li>Server-side browser compatibility layer</li>
</ul>

<p>Both of the above components are used exclusively to work around
limitations in the browser's JavaScript interpreter.</p>

<h3>CSS User Interface</h3>

<p>The overall design of the CSS user interface will be composed of a
central rendering/touchscreen area surrounded by two optional, hidable
panels: a top panel (topbar) and a side panel (sidebar).</p>

<p>The old MATLAB tracks viewer looked like this:
  <code><a href="matlab_eddy_viewer.png">
      matlab_eddy_viewer.png</a></code></p>

<h4>General User Interface Design Requirements</h4>

<ul>
  <li>The UI needs to be able to consistenly respond when the user
  presses the escape key.</li>
  <li>The UI should provide a convenient keyboard user interface.</li>
  <li>There will be no "select eddy" button, since just clicking and
  not moving the mouse will select an eddy if it is visible.</li>
  <li>Clicking and dragging the mouse pans the Earth.</li>
  <li>Rolling the mouse wheel forward zooms in, rolling it backward
  zooms out.</li>
  <li>Pulling fingers apart on touchscreen zooms out, pushing fingers
  together zooms in.</li>
  <li>A zoom slider could also be convenient for touchscreen
  users.</li>
  <li>The panels should be able to dynamically hide and show on small
  screen layouts.</li>
  <li>The UI needs to be able to dynamically resize the height on the
  canvas area depending on how much vertical space there is in the
  window.</li>
  <li>There needs to be a legend on the map.  If the colors are to be
  decided by the web application, they need to be specially chosen to
  maximize clarity to colorblind individuals.</li>
  <li>With as many widgets as there are going to be in the user
  interface, there also needs to be a way to iconify the grouping
  boxes.</li>
</ul>

<h3>Renderer</h3>

<p>The renderer contains the logic for projecting and unprojecting
coordinates.  These modules are also used by the UI scripts to
determine the latitude and logitude from a pixel selected on
screen.</p>

<p>The renderer needs to provide fast wireframe rendering of the
grid and land masses for scrolling the maps.</p>

<p>The renderer needs to provide special rendering modes for rendering
"2D" projections.  2D projections are the projections that do not need
to compute the inverse tilt transformation in three dimensions.  These
projections are special because it is possible to support a wider
range of browser compatibility with these projections than is the case
for the 3D projections.</p>

<p>For the 3D projections, there is a 2D backbuffer where SSH, land
masses, and track rendering is performed on.  At higher zoom levels,
this backbuffer will need to be rendered at a higher resolution.  At
the same time, only a smaller portion of the map will be visible.
Thus, for a responsive UI, only the visible portion of the map should
be rendered.  Also, it is not practical to store very high resolution
maps prerendered, so the backbuffer will act as a local cache in this
case, only storing prerenders for closely surrounding areas at the
same zoom level.  In order for this to work well, a quadtree or
kd-tree is also needed to quickly lookup only the eddies that are
within the visible map area.</p>

<p>Parts left TODO:</p>

<ul>
  <li>clipGeometry()</li>
  <li>getClipBounds()</li>
  <li>inverseZRot(x, y) -> { x, y }</li>
  <li>rotateX, rotateY, rotateZ</li>
  <li>Wireframe render</li>
  <li>2D version: only one frontbuffer.  Bit-block images
  verbatim.</li>
  <li>For raytrace renders, start rendering 1/4 down from top of
  screen, continue to bottom, finish top 1/4.</li>
  <li>Highlight selected eddy.</li>
</ul>

<h3>Data I/O</h3>

<p>This part of the web viewer handles loading of data that is
possibly segmented into multiple files on the server.  It can also
provide mechanisms for exporting rendered raster/vector images and
exporting image sequences that can be used for animations.</p>

<p>There can also be a <em>server-side</em> data I/O component that is
primarily used to segment large datasets into individual files for
bandwidth optimized data downloading.  This would only be necessary if
(1) the dataset needs to be parsed serially as opposed to random
access and (2) low-level (HTTP) protocol control cannot be achieved by
the web viewer.</p>

<p>Parts left TODO:</p>

<ul>
  <li>Request data</li>
  <li>Write data</li>
  <li>Format detection</li>
  <li>Format handlers</li>
</ul>

<p>--Avoid complicated OOP, this can really slow down compilers and
static implementations.  Try to stick to fast-style coding when
possible.</p>

<p>Great advice on getting ellipses to render with constant line
width:</p>

<p><a href="http://stackoverflow.com/questions/2172798/how-to-draw-an-oval-in-html5-canvas">
  http://stackoverflow.com/questions/2172798/how-to-draw-an-oval-in-html5-canvas</a></p>

<p>Clipping does not need to be performed manually, since it will be
done by the underlying canvas implementation as needed.</p>

<p>This leaves things up to tree lookup.</p>

<p>Drawing clipped polygons.  For each polygon, first determine which
clock-winding direction corresponds to the closed polygon.  Then use
clock-winding rule to determine interior of polygon.  Once the
interior of the polygon has been found, draw with the two points just
off the screen and add vertices for each screen coordinate located
within the polygon.</p>

<p>Drawing other projections:</p>

<ol>
  <li>Initialize bitmap backbuffers via unprojection tracing from the
   target buffer pixels.</li>
  <li>While rendering any features, transform the point by the current
   projection.</li>
</ol>

<p>Always store relatively large render caches as tiled image buffers, up
to a maximum size.  Must keep this small in order to preserve
compatibility with older browsers.</p>

<p>Want to link zoom factor and field of view?  Here's how.</p>

<p>Calculate the radius of the projected sphere.  Field of view.</p>

<p>Map orthographic to perspective.</p>

<h3>HTML Validity Checklist</h3>

<ul>
  <li>Verify void tags end with " />"</li>
  <li>Run all documents through the CSS and markup validators.</li>
  <li>Verify all inline scripts have polyglot wrapping markers.</li>
  <li>Verify all documents use IE6 CSS fallbacks.</li>
  <li>Verify all CSS layouts have IE6 CSS fallback scripts.</li>
  <li>Do not use the SVG loading image by default.</li>
  <li>Preload GUI icon images.</li>
  <li>Check that all the "alt" tags have reasonable text.  Either use
  brackets or periods to delimit the end of identifiers.</li>
  <li>Check all webpages in Lynx and w3m.</li>
</ul>

<h3>JavaScript Checklist</h3>

<ul>
  <li>Keep the identifiers in camelCase.</li>
  <li>Parse text fields more gracefully.</li>
  <li>Always perform error checking whenever applicable.</li>
  <li>Use parseInt() to parse user input numbers.</li>
  <li>Add "use strict" to all production code and test.</li>
  <li>Avoid over-object-orientation and try to test code quickly after
  it is written.</li>
  <li>Benchmark the memory consumption of having a certain number of
  JavaScript objects around, gauge "stack" variables and garbage
  collector leftover waste.</li>
  <li>Check for "~~" and replace with "0|".</li>
  <li>Verify that all HTML Canvas operations are structured so as to
  be supported on all conforming browsers.</li>
  <li>Always use parentheses with typeof operator?  `delete' operator
  too?</li>
  <li>Always use document.x() and window.x() rather than the global
  namespace name.</li>
  <li>Check all for() loops for where the `var' is initialized.</li>
  <li>Check for single line comments styled as
  <code>/* ... */</code></li>
</ul>

<h3>Reference Documentation</h3>

<p>These are the major reference documentation sources that I've
consulted to put together.  Some of the information in the following
sources is very hard to find on the general Internet.</p>

<h4>Mozilla Developer Network: Web Platform</h4>

<p><a href="https://developer.mozilla.org/en-US/docs/Web">
  https://developer.mozilla.org/en-US/docs/Web</a></p>

<p>Contains basically all documentation you'll ever need for modern
web development.</p>

<h4>HTTP 1.1 Specification</h4>

<p><a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html">
    http://www.w3.org/Protocols/rfc2616/rfc2616.html</a></p>

<p>The HTTP 1.1 Specification is useful for constructing
XMLHttpRequest objects.</p>

<h4>Microsoft Windows Server 2003 R2 Platform SDK.</h4>

<p><a href="http://en.wikipedia.org/wiki/Microsoft_Windows_SDK">
  http://en.wikipedia.org/wiki/Microsoft_Windows_SDK</a></p>

<p>Useful for information on web development for Internet Explorer
versions 4-6.  Since this information has been removed from the
current web version of the MSDN library, you'll have to download the
above Windows PSDK to gain access to the information.  I can't provide
a URL to Microsoft's website since Microsoft's keeps changing/deleting
content from their website.  Wikipedia is currently (as of 2014) the
best online source for download links to reference.  You can also
probably buy used CDs of the platform SDK from Ebay.  Once you've got
access to a copy of the information, to actually view the information,
you'll need a sufficiently Windows-compatible environment to run the
help viewers that come with the PSDK, or you'll need to figure out how
to extract the HTML from the bundled help file formats.  Tough luck,
but that's Microsoft for you.</p>

<h4>Computer Graphics Concepts and Technologies</h4>

<p>Sorry, but I can't provide sources for this information.  The
related parts of this program builds upon too many years of experience
for me to recommend only a single source.  You're going to have to
search for relevant books/documents yourself.  You should be familiar
with the following concepts/technologies:</p>

<ul>
  <li>3D transformations, transformation matrices</li>
  <li>Perspective projection</li>
  <li>Hidden geometry culling/clipping</li>
  <li>Binary Space Partitioning (BSP) trees</li>
  <li>Quadtrees/octrees and kd-trees</li>
  <li>OpenGL programming</li>
  <li>OpenGL vertex shaders and fragment shaders</li>
</ul>

<pre>----------------------------------------</pre>

<p>Pre-load an image?  Just use JavaScript and HTML 5 image loading
like so?</p>

<p><a href="http://www.htmlgoodies.com/tutorials/web_graphics/article.php/3480001">
http://www.htmlgoodies.com/tutorials/web_graphics/article.php/3480001</a></p>

<p>Great!  Image flipping, pre-render and then flip at high speed.</p>

<p><a href="http://www.htmlgoodies.com/tutorials/web_graphics/article.php/3479941">
http://www.htmlgoodies.com/tutorials/web_graphics/article.php/3479941</a></p>

<p>Want to make a link open in a different window?</p>

<p>Use &lt;a href="..." target="resource window"&gt;&lt;/a&gt; as one
method.</p>

<p>Use &lt;a href="..." target="_blank"&gt;&lt;/a&gt; to open in a new
tab/window.</p>

<pre>
----------------------------------------

About box

If you are having problems with the web viewer, check if your browser
meets the minimum requirements and passes the browser CSS and Event
test suite and the JavaScript language test suite.  (Reference
renderings at 96 DPI.)  If it is possible to workaround a bug or
issue, send a patch to us and we will include it in the web viewer.

The viewer should have virtually no problems on all browsers that meet
the minimum requirements.  See the list of browsers known to work, and
drop a comment if you think this is not good enough.  For lighter
weight systems, a native application written in C is also available.

----------------------------------------

(At first, I thought the reason for the latitude and longitude arrays
was because the SSH data was encoded as a sparse array.  It turned out
that it is just uniformly arranged image data.)

The SSH data are just images of a reasonable size, no special handling
required.

Earlier, I was thinking about possibly using quadtrees in the viewer.
However, since memory allocation is considerably expensive in
JavaScript, I've changed my mind to instead opt on using kd-trees
exclusively, since they have the best economization on both memory
consumption and CPU performance.

----------------------------------------

Need new CSS GUI test suites:

Box resize check

Mouse wheel check

CSS compatibility: Do not use periods in element IDs.

Fast and efficient way to get the current time in milliseconds:

if (!Date.now) {
  Date.now = function now() {
    return new Date.getTime();
  };
}

Date.now;

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/now

----------------------------------------

Great high performance JavaScript CSV parser:

https://code.google.com/p/jquery-csv/

JQuery?  JQuery?!!!!  No way.  I'm not using it after all, binary data
will do much better.

----------------------------------------

Once I tried switching the buttons in the CSS GUI to from list
elements to FORM buttons.  I've encountered a box sizing problem:

http://stackoverflow.com/questions/6790512/button-padding-width-problem

http://social.msdn.microsoft.com/Forums/sharepoint/en-US/
131670eb-e08c-4ee6-9575-fe9ff1ef2561/
no-focus-rectangle-on-checkboxes-or-radiobuttons?forum=sharepointdevelopmentlegacy

I also need to document a possibility for an ASCII Art rendering
backend.

Why not use d3.js?  Short answer: "copy and modify" source code.
d3.js is not already written to run on the GPU via a WebGL shader, so
its best to work with code that I can manage rewriting for that task.

Since the resolution will always be 1440x721 for this project, there
will be no need to break up images into tiles: the resolution is low
enough for such additional software complexity to be unjustified.

----------------------------------------

Code base plans

Alright, let's break up the renderer and implement it:

Unit testing: JsUnit, QUnit

(Avoid the above frameworks, they do not maintain faithful
cross-browser compatibility.)

Discovery, design, component implementation/testing, composition.

Need to have table of acronyms and abbreviations


Good, I should be in good shape for performance counting when I use
performance.now() on Windows systems.  Don't worry, it's a drop-in
replacement for Date.now().

Date.now() is newer than +new Date().

Cite blue marble dataset in credits.

----------------------------------------

Video and Rendering

Need to check quirksmode compatibility tables for mobile devices.

GLSL shaders?  Only for big machines.

http://earthobservatory.nasa.gov/Features/BlueMarble/?src=ve

Would streaming video allow SSH animations?

http://willus.com/author/streaming2.shtml

Here's how to track pinch events:

http://stackoverflow.com/questions/11183174/simplest-way-to-detect-a-pinch
https://developer.apple.com/library/safari/documentation/UserExperience/Reference/GestureEventClassReference/GestureEvent/GestureEvent.html

This is also useful:

http://quirksmode.org/dom/events/resize_mobile.html

todo add rendering for outline land masses

----------------------------------------

Want a nice, translucent background on a CSS element?

http://robertnyman.com/2010/01/11/css-background-transparency-without-affecting-child-elements-through-rgba-and-filters/

Wow!  Here's another way to include images inline:

http://css-tricks.com/data-uris/
http://css-tricks.com/32766/
http://css-tricks.com/snippets/htaccess/active-gzip-compression/

Unfortunately, IE 5-7 does not support this.

If the user's browser doesn't support this, the data will have to be
routed back to the user via the server.  Luckily, most people do not
use browsers that are too old to have support, so this will not impose
undue burden on the server.

Great!  This is even better to finish things off:

http://www.xarg.org/2010/03/generate-client-side-png-files-using-javascript/
http://www.xarg.org/download/pnglib.js

Plus, it's even reported to have faster per-pixel manipulation than
HTML Canvas!  Execpt at large sizes...

Take note: For better speed, use brower's base64encode:

this.getBase64 = function() {
return window.btoa(this.getDump());
}

Plus, this also has the added advantage of an efficient 8-bit image
copying mechanism.  So you could generate an image 8-bit inline and
work with that with this library.  But... read from an 8-bit
downloaded image?  Not so much.

I should improve the library so that it includes fast single pass
stream encoding.  Multiple loops incur extra overhead.

----------------------------------------

Can you check the loading progress of an image created via new
Image()?  Not quite... sort of, but only with modern browsers.

http://stackoverflow.com/questions/14218607/javascript-loading-progress-of-an-image

----------------------------------------

Could this be the solution to the problem of Internet Explorer giving
me extra space underneath the iconBtns?

http://bonrouge.com/br.php?page=faq#img-gap
http://www.sitepoint.com/forums/showthread.php?249148-IE-puts-extra-space-at-bottom-of-image-in-a-div

That will do it.  But wow, that sure is a strange way to do it, very
non-CSS like in order to get the IE-style box model to work.

----------------------------------------

Web Workers can be used for multiprocessing.

However, Web Workers will be of limited applicability, since passing
data back and forth to a Web Worker is non-trivial and efficient data
transfers are not available on Firefox 3.6.

----------------------------------------

Performance optimization: Go through my code and change all constants
to #define and likewise for inline functions.

----------------------------------------

Additions to the CSS GUI:

* Use a page-turning calendar icon with a white top band for the
  "current date" field.

* Use a compass icon for the "Latitude, Longitude" field.

* Add drop-down sliders to all numeric configurable fields.  The
  drop-down slider allows both click-and-drag and arrow panning, like
  a scrollbar.  Also add vertical precision slider too.

** Do not waste screen space to add this advanced option.  Make the
   user double-click on the label to get to this.

** Start by displaying a blue shaded circle in the center of the
   screen.  The popup info displays the modal status and allows the
   user to exit by clicking on the X.  When the user clicks and drags
   on the blue dot, the popup is updated with the scale, current
   value, etc.

* Separate min and max track lengths.

"trademark" continuous variable value adjuster.  I'll have to see if
time permits me to add this or not.

----------------------------------------

Just to reiterate.  These are the forms of progressive raytrace
rendering that I need to implement:

* "Interlaced" rendering: Starting at a minimum resolution, render at
  progressively higher resolutions.  Must verify that browser can use
  nearest pixel sampling, though.

* "Center" rendering: Render a small portion of the center at full
  resolution, then progressively render the surrounding areas.

Perhaps I should also make the preemption interval user-configurable,
though the default should be good for most people who have modern
systems.

I also must absolutely implement storing the configuration within the
address bar hash fragment.  This feature proves to be invaluable for
communicating with others.

Think about how you would implement the GPU code... for each separate
rendering projection, you would implement a separate fragment shader.
Why be afraid to do the same with JavaScript.  Sure, you can have the
modular implementation, slow but easy for development, and you can
have the fast implementation, the one that uses only a dedicated
projection method.  All of the projection methods would be implemented
as macros for either way, of course.  Although math function calls are
okay, try to minimize user-code function calls in inner loops.  Don't
worry about scalar variable definitions, it will be okay as long as
you periodically return from the code to allow the garbage collector
to operate.

----------------------------------------

Need a coding scratch space?  Got one right here.

Iterations to timeout algorithm:

/* Dynamically determine a goal number of iterations to run in order to
   reach the target timeout, based off of the number of iterations that
   could be performed in the previous cothread duration.  */

/* The main benefit of this cothreading mechanism is that it avoids
   expensive calls to Date.now() during the inner loop.  */

var timeout = this.timeout;
var lastElapTime = this.lastElapTime;
var lastNumIters = this.lastNumIters
var numIters = lastNumIters * timeout / lastElapTime;
var timeoutIter = this.i + numIters;

lastTime = Date.now();

for (; i < timeoutIter && condition; i++) {
}

lastElapTime = Date.now() - lastTime;
lastNumIters = numIters;

/* The above algorithm can also be nested within a loop that calls
   Date.now() on every iteration.  */

Buffering data:
loadData() handles this.

Cothread dispatcher:

Note that it is possible to use an array of cothreads that still have
work to do and only call those cothreads.  For simplicity, however,
cothreads are a always called to continueCT() until there is no work
left to do.  Only event handlers call start().

cumStatus = CothreadStatus.FINISHED;
renderReady = setViewport();
addStatus = loadData.continueCT(maybeAddToBuffer);
if (addStatus) cumStatus = addStatus;
if (renderReady)
  render.continueCT();

if (cumStatus != CothreadStatus.FINISHED)
  return setTimeout(browserTime);

----------------------------------------

Useful search engine information:

http://www.feedthebot.com/
http://googlewebmastercentral.blogspot.com/2007/02/discover-your-links.html
http://en.wikipedia.org/wiki/Attention_economy
http://en.wikipedia.org/wiki/Nofollow

----------------------------------------

Video encode the SSH data:

ffmpeg -threads 2 -r 25 -i vidgen/ssh_%05d.jpg -r 25 -s 1440x720 \
  -b 16000k ssh.ogv

ffmpeg -threads 2 -r 25 -i vidgen/ssh_%05d.jpg -r 25 -s 1440x720 \
  -vcodec mpeg4 -b 16000k ssh.mp4

* Since canvas is linked to window size, you can simply listen for
  onresize events to repaint the canvas.

----------------------------------------

And for simulating colorblind vision:

http://vischeck.com/

----------------------------------------</pre>

<hr />
<!-- ________________________________________ -->

<h2><a name="comp_center" id="comp_center">
    Compatibility Center</a></h2>

<p><a href="http://www.quirksmode.org/">
    http://www.quirksmode.org/</a> is a great website for extensive
    compatibility tables for both CSS and JavaScript.</p>

<h3>Web Development</h3>

<p>Many modern browsers disable or severely impair scripts from HTML
read from regular files on the filesystem.  As far as the web browser
knows, the DocumentRoot of the "website" is just the root of the
filesystem, which is considered very insecure.  Although it is
sometimes possible to configure the web browser to have different
security settings, this cannot be done efficiently with different
versions of the same browser.  Thus, serverless web development won't
get you anywhere for working on this web application and you'll need
to have a web server setup for testing the web application.</p>

<p>Take a look at these links for more information:</p>

<ul>
  <li><a href="http://stackoverflow.com/questions/358538/getimagedata-in-firefox-3-causing-ns-error-dom-security-err">
      http://stackoverflow.com/questions/358538/getimagedata-in-firefox-3-causing-ns-error-dom-security-err</a></li>
  <li><a href="http://www-archive.mozilla.org/projects/security/components/jssec.html">
      http://www-archive.mozilla.org/projects/security/components/jssec.html</a></li>
  <li><a href="http://stackoverflow.com/questions/17035106/context-getimagedata-operation-is-insecure">
      http://stackoverflow.com/questions/17035106/context-getimagedata-operation-is-insecure</a></li>
  <li><a href="http://stackoverflow.com/questions/4069400/canvas-getimagedata-doesnt-work-when-running-locally-on-windows-security-exce">
      http://stackoverflow.com/questions/4069400/canvas-getimagedata-doesnt-work-when-running-locally-on-windows-security-exce</a></li>
</ul>

<h3>Mathematics on the Web</h3>

<p>NOTE: Mathematics display is not necessary for the viewer, but it
is helpful for this documentation.</p>

<p>Although there was one point in the past where MathML was well
supported by majority browsers, modern browsers are neglecting good
functions for mathematics display.  MathML support was dropped from
Google Chrome, and Internet Explorer on Windows 8 does not support
plugins like MathPlayer.</p>

<blockquote>
  <p>You shouldn't annoy researchers. They'll all gang up on you and
  it wont be pretty</p>
</blockquote>

<p><a href="http://www.cnet.com/news/google-subtracts-mathml-from-chrome-and-anger-multiplies/">
    http://www.cnet.com/news/google-subtracts-mathml-from-chrome-and-anger-multiplies/</a></p>

<p>Although MathJax has been reported to result in a slower
mathematics browsing experience than MathML, there are ways around
this.  Rather than using LaTeX equations in your HTML documents with
MathJax, you should first convert them to MathML and insert the MathML
in your documents.  Then load the <code>MML_HTMLorMML</code> config
for MathJax on your webpage.  This will result in MathJax using the
browser's native MathML display when it is of sufficient quality and
falling back to HTML output otherwise.  MathML-to-HTML translation is
considerably faster than LaTeX-to-intermediate-to-HTML
translation.</p>

<h3>SVG Compatibility</h3>

<p>For best backwards compatibility support, avoid text and clones in
SVG images.  Also note that older versions of Firefox (3.6) treated
SVG images as "documents" and did not support including SVG images in
a document via the <code>&lt;img&gt;</code> element.  Note that when
an SVG image is included in a document via
the <code>&lt;img&gt;</code> element rather than via
the <code>&lt;object&gt;</code> element or some other inlining method,
there are a
  <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/SVG_as_an_Image#Restrictions">
    variety of limitations applied to the SVG image.</a></p>

<p>You cannot embed and SVG image within an HTML 4.01 page by
inserting the SVG source code verbatim.  You must use XHTML in order
to embed an SVG image by inserting the source code verbatim;
otherwise, you should use a script to add the SVG image during
document loading.</p>

<h3>Image Compatibility</h3>

<p>Images on the web traditionally has only two compatibility
categories: PNG and JPEG.  Generally, no other image formats are
widely supported by web browsers.</p>

<p>Although the superior JPEG 2000 format, intended to replace
traditional JPEG, is available, there has been very little support for
it in browsers.  These are the main reasons:</p>

<ol>
  <li>The JPEG 2000 format is generally assumed to be
  patent-encumbered.</li>
  <li>Even when it may seem that certain portions of the JPEG 2000
  format have no patent risk, random companies might rise up to sue
  random people if browser developers were to include support for JPEG
  2000.</li>
  <li>The JPEG 2000 format is too complex: adding all the necessary
  code to support JPEG 2000 images into web browsers would
  dramatically increase the binary file size of a compiled web browser
  executable.</li>
  <li>Due to the complexity of the JPEG 2000 format, existing
  implementations exhibit conflicting behavior when processing the
  same image.</li>
</ol>

<p>That's all to say that JPEG 2000 is not widely supported by modern
web browsers.  Just don't use it.  Period.</p>

<ul>
  <li><a href="http://blog.codinghorror.com/beyond-jpeg/">
    http://blog.codinghorror.com/beyond-jpeg/</a></li>
  <li><a href="http://blogs.loc.gov/digitalpreservation/2013/01/is-jpeg-2000-a-preservation-risk/">
    http://blogs.loc.gov/digitalpreservation/2013/01/is-jpeg-2000-a-preservation-risk/</a></li>
</ul>

<h3>Video Compatibility</h3>

<p>Videos on the web traditionally required a plugin such as Adobe
Flash.  With HTML 5, however, web browsers themselves were extended to
have internal support for video playback.</p>

<p>Using plugins for video on older browsers is likely going to be
insufficient for this project, since it requires that the video data
be accessible by the JavaScript execution context or a WebGL fragment
shader.</p>

<p><strong>There are only two video formats available in HTML 5 that
have <em>marginal</em> support across modern web brosers.</strong>
For the very latest web browsers, one format has slightly better
support than the rest:</p>

<ul>
  <li>H.264 compressed video stream within an MP4 container</li>
  <li>WebM</li>
  <li>OGG Theora</li>
</ul>

<p>H.264 is the only video codec supported by modern versions of
Internet Explorer (IE 10 or later).  Compared to the other vieo
formats, it has the best compression.  It also comes with the price of
patents.  Thus, WebM was created as an open-source alternative to the
patent encumbered H.264 video codec.  OGG Theora no longer has much
support in recent browsers: WebM has made it obsolete.  However, it is
the only video format supported by older versions of Firefox such as
Firefox 3.6.</p>

<h4>Patent Status</h4>

<p>Business as usual, non-trivial multimedia formats are patent
encumbered, and this includes <em>all</em> of the above video
formats.</p>

<p>The H.264 codec requires patent royalties for encoding and
decoding.  The MPEG LA organization administers the royalties from
this patent pool (and also handles litigation of infringers).
However, these patents are primarily used to chase down large
companies selling millions of copies of software: the price for an
encoding license for one software unit is on the order
of <strong>$2</strong>.  Thus, it's unlikely that this will create any
problems for individual use by small time researchers in an
oceanographer's niche subject.</p>

<p>In the past, MPEG LA was claiming that the both WebM and OGG Theora
have been infringing its patent pool.  However, in 2013, MPEG LA
agreed to license the patents relevant to the WebM format to Google
"under a 'perpetual, transferable, royalty free license'.  This means,
effectively, that all known patents on the WebM format are licensed to
everyone for free."<br />
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats">
    https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats</a><br /></p>

<p>The VP8 codec used in WebM is a newer version (i.e. enhanced
derivative) of the Theora video codec.  Thus, for all practical
purposes, the above patent licensure for WebM also applies to OGG
Theora.</p>

<p>To summarize, patents will not be an issue for encoding the SSH
background as a video for the Eddy Web Viewer.</p>

<ul>
  <li><a href="http://en.wikipedia.org/wiki/MPEG_LA">
  http://en.wikipedia.org/wiki/MPEG_LA</a></li>
</ul>

<h3>HTML Compatibility</h3>

<p>Make sure your browser is sending the right charset in the HTTP
Content-Type headers for the character set; otherwise, you are not
going to be able to read extended characters correctly.</p>

<h3>XHTML Compatibility</h3>

<p>HTML presents many breaking changes from HTML 4.01.  Here is a list
of the changes and links to additional resources:</p>

<ul>
  <li>You need to make sure your web server is setup to serve XHTML
  documents with "application/xhtml+xml".<br />
  Setup Apache to server XHTML: <br />
  <a href="http://protempore.net/~calvins/howto/xhtml-apache/">
    http://protempore.net/~calvins/howto/xhtml-apache/</a></li>
  <li><a href="http://www.456bereastreet.com/archive/200501/the_perils_of_using_xhtml_properly/">
      http://www.456bereastreet.com/archive/200501/the_perils_of_using_xhtml_properly/</a></li>
</ul>

<h3>CSS Compatibility</h3>

<p>Dealing with vertical space is very difficult in CSS.  The
solutions also tend to cause a lot of problems with cross-browser
compatibility.  The most reliable way to perform vertical space
operations such as vertically centering a box or expanding a box to
fill up all of its available space is to write a script to perform the
task.  One such script is included in the browser test suite.</p>

<p>Internet Explorer 6 also has an almost entirely different box model
than is described by the CSS Specification.  The details are described
in the next section.</p>

<h3>Internet Explorer Compatibility</h3>

<p>Microsoft Internet Explorer versions 5-8 are long known to cause
many more problems for web developers than equivalent older versions
of other browsers.  This is made worse by the fact that Internet
Explorer is also a very popular browser.  Most people are likely using
the latest version of Internet Explorer; however, a key older version,
version 6, is still in use by many people for a variety of reasons,
which will not be detailed here.  Here is a list of the most important
limitations in Internet Explorer 6:</p>

<ul>
  <li>IE6 does not understand XHTML served with the
  "application/xhtml+xml" MIME type or files with a ".xhtml"
  extension:<br />
  <a href="http://bytes.com/topic/html-css/answers/161030-application-xhtml-xml-ie">
    http://bytes.com/topic/html-css/answers/161030-application-xhtml-xml-ie</a></li>
  <li>Detect IE versions for both CSS and JavaScript most flexibly:<br />
  <a href="http://stackoverflow.com/questions/10964966/detect-ie-version-in-javascript">
    http://stackoverflow.com/questions/10964966/detect-ie-version-in-javascript</a></li>
  <li>IE5 interprets "width" and "height" to mean the content
  width/height, plus the padding, plus the border widths.  IE6 doesn't
  do this when standards-conformant mode is triggered via a DOCTYPE
  declaration.</li>
  <li>You probably cannot go further back in time to support DHTML and
  JavaScript on a browser earlier than Internet Explorer 5.5.</li>
  <li>The display style "<code>inline-block</code>" is incomplete and
  buggy in IE6 and IE7.  Often times, you can get the intended effect
  if you use "<code>inline</code>" instead, but only if you use it in
  a stylesheet definition, not an inline style definition.</li>
  <li>Centering an element both horizontally and vertically in a way
  that is cross-browser to IE6 requires the techniques described in
  the following link:<br />
  <a href="http://stackoverflow.com/questions/396145/whats-the-best-way-of-centering-a-div-vertically-with-css">
    http://stackoverflow.com/questions/396145/whats-the-best-way-of-centering-a-div-vertically-with-css</a><br />
  Note that this will not work in IE5.5.
  </li>
  <li>You cannot use both the "<code>top</code>" and
  "<code>bottom</code>" positioning properties at the same time.  Same
  goes with "<code>left</code>" and "<code>right</code>".  If you want
  to vertically expand a box to fill up its available space, then you
  must either 1) set the width/height to 100% and avoid using borders
  and margins or 2) write a JavaScript to expand the box.  Keep in
  mind the differences of box layout between IE5 and IE6 when doing
  this.</li>
  <li>All versions of IE that support scripting generally support it
  well.  Expect JavaScript 1.5 to be well supported.  However, you
  must take care not to use certain web API scripting idioms that
  won't be supported by IE, such as<br />
    element.setAttribute('style', 'styleText');<br />
  as opposed to<br />
    element.style.cssText = 'styleText';<br />
  Note, however, that old versions of Firefox may not support
  object-oriented CSS style manipulation.</li>
  <li>Avoid inline styling: Using inline style information can sometimes
  trigger bugs in Internet Explorer that are not present when using
  stylesheets.</li>
  <li>IE6 cannot properly render transparent PNG images.  Use 8 bit
  PNG images with single color transparency instead.  Note that you
  can also enable a transparency filter, but it is buggy and can cause
  crashes.</li>
  <li>IE6 does not
  support <code>document.getElementByClassName()</code>.  Use
    <a href="http://robertnyman.com/2008/05/27/the-ultimate-getelementsbyclassname-anno-2008/">
      Robert Nyman's <code>getElementByClassName()</code></a>
    cross-browser implementation instead.</li>
</ul>

<p>Additional resources:</p>

<ul>
  <li><a href="http://stackoverflow.com/questions/4359848/in-ie6-what-are-the-alternatives-to-display-inline-block-table-table-row-ta">
      http://stackoverflow.com/questions/4359848/in-ie6-what-are-the-alternatives-to-display-inline-block-table-table-row-ta</a></li>
  <li><a href="http://stackoverflow.com/questions/6544852/ie7-does-not-understand-display-inline-block">
      http://stackoverflow.com/questions/6544852/ie7-does-not-understand-display-inline-block</a></li>
  <li><a href="http://www.positioniseverything.net/explorer/expandingboxbug.html">
      http://www.positioniseverything.net/explorer/expandingboxbug.html</a></li>
  <li><a href="http://www.webcredible.com/blog-reports/css/internet-explorer.shtml">
      http://www.webcredible.com/blog-reports/css/internet-explorer.shtml</a></li>
</ul>

<h3>JavaScript Compatibility</h3>

<p>First of all, some background information will help.  ECMAScript
(JavaScript) benefits from being a well standardized language that has
undergone very few changes over the years.  The major changes that are
relevant to web apps are only changes within the <em>Web APIs</em>,
the JavaScript host objects provided by the browser for the
JavaScript.  However, there are a few notable changes in the native
JavaScript language since the very first version:</p>

<ul>
  <li>The <code>push()</code> and <code>pop()</code> Array methods did
  not exist in the first version of JavaScript.</li>
  <li>Strict mode was added to later versions of JavaScript, which is
  the mandatory mode for newer features introduced by newer
  specifications.<br />
  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions_and_function_scope/Strict_mode">
    https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions_and_function_scope/Strict_mode</a></li>
  <li>Later JavaScript runtimes feature the typed array
  extensions.</li>
</ul>

<p>This makes JavaScript similar to C in that although the language
syntax is fairly standardized, the features available on the system
vary drastically.  In C, this has prompted the creation of ahead of
compile-time feature detection scripts (such as Autoconf) to determine
if the software is being compiled in a suitable development
environment.  Likewise, one would expect that all good JavaScript
programs would use similar feature detection: Since JavaScript is not
a compiled language, the standard mechanism would be to use a feature
detection framework before the main body of the script executes, and
if the required features are not available, the main body of the
script will not be executed.</p>

<p>Unfortunately, this has not been the case for the mass majority of
JavaScript programs.  Why?  In case you have forgotten, JavaScript is
a language used by many people who would not be considered skilled
programmers, so the most popular method of implementing JavaScript
programs involves simply assuming that the user is using a "reasonably
new" browser that is similar enough to the developer's browser for
things to run smoothly.  When this is not the case, the script simply
crashes without any meaningful communication to the user that their
browser is unsupported.</p>

<p>This even applies to the most popular JavaScript libraries: JQuery,
Dojo, you name it.  They're all "sizzle without solid substance," as
the author of My Library put it.</p>

<p><em>Multi-browser</em> scripting refers to scripts that only work
across a small range of modern and popular web browsers, excluding the
time immediately after the release of the latest versions of popular
browsers, which typically break multi-browser scripts.  Multi-browser
scripts typically use browser detects (<code>isMSIE</code>,
<code>isFirefox</code>, <code>isSafari</code>, <code>isChrome</code>,
but no other browsers than those) and platform detects
(<code>isWin</code>, <code>isMac</code>, but no other platforms than
those) in order to achieve their desired functionality on the most
popular browsers and platforms <em>of the current time</em>.
<em>Cross-browser</em> scripts, on the other hand, use feature
detection and testing techniques to determine what code can be run on
the user's browser.  These scripts never, ever, ever, <em>ever</em>
use browser or platform detects under any circumstances.  Thus, these
scripts tend to work better on a larger range of non-Windows and
non-Mac OS X platforms.  Cross-browser scripts remain cross
browser <em>forever</em>.</p>

<p><a href="http://en.wikipedia.org/wiki/Cross-browser">
  http://en.wikipedia.org/wiki/Cross-browser</a></p>

<p>So what are the useful cross-browser libraries out there?</p>

<ul>
  <li><a href="http://www.cinsoft.net/mylib.html">My Library</a>
  &mdash; The earliest and a very highly recommended cross-browser
  JavaScript library</li>
  <li><a href="https://github.com/rassie/jessie">Jessie</a> &mdash;
  Another newer cross-browser library, made by the same author of My
  Library</li>
  <li><a href="http://www.fortybelow.ca/Projects/JavaScript/Utils/">
  Matt's DOM Utils</a> &mdash; Modular, general-purpose DOM library</li>
</ul>

<p>Note that the builders that come with the cross-browser libraries
above are mostly there for web developers who are not using JavaScript
minifiers that can automatically remove dead code.</p>

<h4>Miscellaneous</h4>

<p>Note: The innerHTML and outerHTML properties, though intuitive and
easy, are nonstandard, notably introduced by IE5.5.</p>

<p><a href="http://spoken.fortybelow.ca/Browser_Scripting_101/">
    http://spoken.fortybelow.ca/Browser_Scripting_101/</a></p>

<p>Rather than using using these properties, consider using the
standardized HTML DOM mechanism.  If, for example, you would like to
add plain text within an element, you must first create a text node,
then use <code>element.appendChild()</code> to insert the text node in
the parent element.<br />
  <a href="http://www.w3.org/DOM/">http://www.w3.org/DOM/</a></p>

<p>(The information above is also available in Mozilla Developer
Network.)</p>

<h4>Additional cross-browser articles</h4>

<ul>
  <li><a href="http://michaux.ca/articles/feature-detection-state-of-the-art-browser-scripting">
    http://michaux.ca/articles/feature-detection-state-of-the-art-browser-scripting</a></li>
  <li><a href="http://spoken.fortybelow.ca/Browser_Scripting_101/">
    http://spoken.fortybelow.ca/Browser_Scripting_101/</a></li>
</ul>

<h3>Web API Event Compatibility</h3>

<h4>Mouse Pointer Coordinates Compatibility</h4>

<p>When a page has a vertical scrollbar, it can be impossible on some
older browsers to determine where the mouse pointer is located.
Without a vertical scrollbar, it is possible to determine the mouse
pointer's location with a few capability checks.</p>

<p>If there is <code>event.pageX</code> and <code>event.pageY</code>
available, use them.  They will always refer to the same position on
the HTML page independent of what the scroll bars are set to.</p>

<p>The bare minimum that all but the oldest browsers supports
is <code>event.clientX</code> and <code>event.clientY</code>.
Sometimes this refers to the browser's "client area", the screen
offset from the top-left of the area where the HTML page is rendered
in, other times it refers to the offset from the top-left of the HTML
document.  If there
is <code>document.documentElement.scrollLeft</code>
and <code>document.documentElement.scrollTop</code>
(or <code>document.body.scrollLeft</code>
and <code>document.body.scrollTop</code>) available, add those to the
client position to get the page offset.  Otherwise, if the scrolling
offset is not available, this may mean that this is one of the "minor"
browsers (Opera, Konqueror, and iCab) that define the client
coordinates to be relative to the document rather than relative to the
window, so no scrolling offset needs to be added.  If there is a minor
browser that contradicts this interpretation, then you will have to
write browser detection code to handle that browser specially.</p>

<p>If the page cannot scroll, then you are okay and can simply
use <code>event.clientX</code> and <code>event.clientY</code>
directly.</p>

<p>Sometimes, it may be useful to
subtract <code>element.clientLeft</code>,
<code>element.clientTop</code>, and possibly other quantities
pertaining to a specific element if you are trying to determine the
mouse position within an element.</p>

<p>See the following links for more information:</p>

<ul>
  <li><a href="http://www.quirksmode.org/js/events_properties.html#position">
    http://www.quirksmode.org/js/events_properties.html#position</a></li>
  <li><a href="http://www.quirksmode.org/dom/w3c_cssom.html#windowview">
    http://www.quirksmode.org/dom/w3c_cssom.html#windowview</a></li>
  <li><a href="http://stackoverflow.com/questions/2337795/screen-coordinates-of-a-element-via-javascript">
    http://stackoverflow.com/questions/2337795/screen-coordinates-of-a-element-via-javascript</a></li>
</ul>

<h4>Mouse Wheel Events</h4>

<p>Older browsers had a lot of different ways of handling the mouse
wheel.  The
  <a href="https://developer.mozilla.org/en-US/docs/Web/Reference/Events/wheel">
    wheel event page on Mozilla Developer Network</a> provides a good
cross-browser compatibility function for handling wheel events.</p>

<h4>Mouse Capturing Compatibility</h4>

<p>Many browsers do not support the <code>setCapture()</code> method.
The solution to this problem is usually to set up an event handler on
the <code>window</code> object instead, since the browser will
automatically provide mouse capture when an event handler is connected
to the <code>window</code> object.</p>

<p>Unfortunately, the "<code>loosecapture</code>" event does not work
in Firefox version 30, even though Firefox 30
supports <code>setCapture()</code>.</p>

<p><a href="http://news.qooxdoo.org/mouse-capturing">
  http://news.qooxdoo.org/mouse-capturing</a></p>

<h4>CSS Box Size Change Events</h4>

<p>In modern HTML and CSS, there is no way to listen for an event that
fires when the size of a CSS box changes.  (Older browsers had a
<code>DOMAttrModified</code> event, but it is now
<a href="https://dvcs.w3.org/hg/dom3events/raw-file/tip/html/DOM3-Events.html#event-type-DOMAttrModified">deprecated</a>.)
Instead, the equivalent functionality must be implemented by polling
at a periodic interval to detect changes.  If a script is frequently
called to refresh the contents of an element, the beginning of the
execution of this script would be the most logical place to put such
polling code.  Otherwise, timer timeouts must be used to call the
polling code.</p>

<h4><code>requestAnimationFrame()</code> Compatibility</h4>

<p>The best possible cross-browser compatibility for
<code>requestAnimationFrame()</code> involves defining a polyfill
shim:<br/ >
<a href="http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/">
http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/</a></p>

<p>It is necessary to use <code>requestAnimationFrame()</code> for any
code that gets frequently executed and makes updates to the screen,
such as a pointer motion handling code, in order to get good rendering
performance in modern versions of Firefox.  Otherwise, the graphics
refresh rate in Firefox is going to trail dramatically behind the
graphics refresh rate in Google Chrome.</p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/Events/resize">
  https://developer.mozilla.org/en-US/docs/Web/Events/resize</a></p>

<hr />
<!-- ________________________________________ -->

<h2><a name="perf_center" id="perf_center">
    Performance Center</a></h2>

<p>Although there's a lot of advice on the Web on how to optimize
JavaScript performance, and although most of the advice is correct,
too much of the advice fails to factor in exactly how large or how
little of a performance gain a certain technique will attain.  The
following questions and answers came from first-hand experience
testing performance optimizations relevant to this project that
resulted in the largest gains.</p>

<p><strong>Do function calls really slow things down?</strong>  No,
not by a noticable amount, unless the function is block nested.  Math
function calls tend to be well optimized even by old JavaScript
runtimes.</p>

<p><strong>Is using a lookup table for trigonometry in JavaScript
faster than using the Math functions?</strong>  No.  However, if the
browser was not compiled with fast math, then the performance of some
trigonometric functions will be slower for some inputs than others.
Using a lookup table in this case is only advantageous if performance
needs to be stabilized so that the computation time is constant for
all input values.</p>

<p><strong>Is named object member access significantly slower than
array element access?</strong>  No.  At least on Firefox 3.6, table
access and object member access are essentially identical in
performance, at least in simple cases.  Newer browsers might provide
more performance optimizations for plain numeric arrays, though.</p>

<p><strong>Are global variables really slower than local
variables?</strong>  Not for simple programs.  However, it's always a
good idea to use local variables when a value is read/written
significantly many times more than once within a function, especially
within loops.</p>

<p><strong>Does moving variable declarations outside of a loop body
reduce garbage accumulation?</strong>  No, this appears not to reduce
garbage accumulation issues within long-running loops.</p>

<p><strong>So where do the real slowdowns happen?</strong></p>

<ul>
  <li>Creation of dictionary and array objects</li>
  <li>Assigning to an array element is slow, at least on Firefox
  3.6.</li>
  <li>Assigning to a named property is also likely to be just as
  slow.</li>
  <li>Even simple table lookups on plain numeric arrays are slow, at
  least on Firefox 3.6.  This might not be as true on newer browsers,
  though.</li>
</ul>

<p>Thus, it is good to avoid creation of any objects, whether it be
with the <code>new</code> operator or by array/dictionary
initializers.  Creation of scalar local variables has no noticable
overhead.  For performance-critical functions that needs to return an
object, pass in a pre-created object as a parameter that will be
manipulated to store the return value.</p>

<p><strong>Is member property access from an object method
(<code>this.property</code>) really slower than direct local variable
access?</strong>  No, but there are some exceptions.  In particular,
you should not access any properties that don't correspond to a real
JavaScript property, such as is the case for a function's arguments
array.  It is also probably a good idea to avoid using properties at
the condition check of a loop.</p>

<h3>General tips on writing more optimal JavaScript</h3>

<ul>
  <li>Since JavaScript is a garbage collected language, it will have a
  lot of issues with excessive memory consumption.
    <ul>
      <li>The #1 best way to deal with these issues is to simply use
      less memory.</li>
      <li>After the first optimization has been verified, avoid
      creating and deleting objects as a means to change the value of
      a variable, since this increases memory fragmentation and waste.
      Opt instead to reuse existing objects as much as possible.</li>
      <li>On Google Chrome running on Windows, severely fragmented
      memory can have dramatic performance penalties.  Additionally,
      any memory wasted by the JavaScript runtime also reduces the
      amount of the script's actual working set that can fit in the
      CPU cache, causing additional slowdowns.</li>
      <li>Try to write your web application so that the user's browser
      does not allocate more than 512 MB of memory.</li>
      <li>Use buffering techniques to optimize the chunk sizes that
      data are processed in, as explained in the last part of this article:<br />
      <a href="http://www.webreference.com/programming/javascript/jkm3/index.html">
      http://www.webreference.com/programming/javascript/jkm3/index.html</a></li>
    </ul>
  </li>
  <li>Do not write long-running loops that don't return after a couple
  of seconds.  The garbage collector cannot run until the JavaScript
  has returned control to the browser.  Even trivial long-running
  loops can quickly exhast all of a browser's available memory.</li>
  <li>Copying primitive variables is cheap in JavaScript.  The
  relative expense of copying objects and arrays has not been
  tested.</li>
  <li>Avoid nesting objects into hierarchies more than one level deep.
  The fixed cost for each hash table lookup is not cheap, but the
  lookup time within a single hash table is essentially constant, even
  on very large tables.</li>
  <li>Avoid placing objects within the global namespace.</li>
  <li>Always use <code>window.alert()</code>, etc. instead of
  just <code>alert()</code>.</li>
  <li>Access to closure-scoped variables is not significantly slower
  than local variable access.<br />
  <a href="http://stackoverflow.com/questions/9248963/javascript-why-the-access-to-closure-variable-might-be-slow">
    http://stackoverflow.com/questions/9248963/javascript-why-the-access-to-closure-variable-might-be-slow</a></li>
  <li>If using aligned native data is an option
  (<code>FloatArray</code>, etc.), use it when reading binary input
  data.  Using function calls to process and convert input data will
  be significantly slower in comparison.</li>
  <li>Avoid DOM manipulations in performance-critical JavaScript.  For
  one example, SVG DOM performance is said to be very poor when
  working with a large number of nodes.  Also, when changing CSS
  inline styles, use the <code>style.cssText</code> property to change
  multiple styles at once.</li>
  <li>Some browsers optimize certain Web API calls more than others.
  Avoid as many Web API calls as possible in performance-critical
  JavaScript.</li>
  <li>If function calls do prove to be an overhead, then you can
  inline the functions where the call is a bottleneck.  Note that the
  Google Closure Compiler is not an optimizing compiler in this
  respect.</li>
</ul>

<h3>Minimizing Download Times</h3>

<ul>
  <li>To improve loading, minimize HTTP requests.  Download data in as
  few streams as possible.  Smash together individual JavaScript
  source files into bundles for your web page.</li>
  <li>Use a JavaScript minifier on your JavaScript bundles to improve
  JavaScript download time.
    <ul>
      <li>YUI Compressor (easiest to install and good compression
      ratio): <a href="http://yui.github.io/yuicompressor/">
	http://yui.github.io/yuicompressor/</a></li>
      <li>Google Closure Compiler:
      <a href="https://developers.google.com/closure/compiler/">
	https://developers.google.com/closure/compiler/</a></li>
      <li>JSMin:
      <a href="http://crockford.com/javascript/jsmin">
	http://crockford.com/javascript/jsmin</a></li>
    </ul>
  </li>
  <li>Combine multiple small images into one.  This is known as the
  "CSS sprites" trick:<br />
  <a href="http://css-tricks.com/css-sprites/">
    http://css-tricks.com/css-sprites/</a></li>
</ul>

<h3>HTML Canvas Performance</h3>

<ul>
  <li>Avoid using very large HTML Canvas elements.  Never use an HTML
  Canvas larger than 4096 &times; 4096 in size.  Since a canvas that
  is that large is unlikely to fit in the texture memory of some GPUs,
  canvas rendering is likely to end up happening on the CPU, which
  will be unusally slow.  Some GPUs have significant performance
  problems working with a canvas of 2880 &times; 1442 in size.  1440
  &times; 721 is a safe size for all systems, though.  If you need to
  work with a larger canvas, consider breaking it up into tiles and
  painting each one individually.<br />
  <a href="https://code.google.com/p/chromium/issues/detail?id=170021">
    https://code.google.com/p/chromium/issues/detail?id=170021</a></li>
  <li>If you need to pack pixels into an image,
  use <code>putImageData()</code>, not a series
  of <code>fillRect()</code> calls.</li>
  <li>Use <code>drawImage()</code> whenever possible.  This function
  is translated into a fast native bit block transfer, which is both
  CPU optimized in software graphics layers and has universal video
  card hardware acceleration for all computers built since 1996.</li>
  <li>Firefox 30's line rasterization performance is slower than that
  of Google Chrome version 35.  The main reason for this is the fact
  that Firefox's Web API call interface is not as well optimized as
  Google Chrome's.  However, the pure JavaScript execution performance
  seems to be nearly identical.  Thus, one way to stablize performance
  between Firefox and Chrome is to use a software line rasterizer, if
  doing so improves performance.  Here's the algorithm to use:<br />
  <a href="http://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">
    http://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm</a></li>
</ul>

<h3>Performance Timers</h3>

<p>Getting elapsed time in milliseconds in JavaScript was
traditionally not a reliable or efficient process.  The earliest
method, <code>+new Date()</code>, required creating a new object,
which is expensive, especially within performance-critical code loops.
The later <code>Date.now()</code> function alleviated this problem.
However, both cases suffer from imprecise timing when the system
updates its time from the network.  The solution to these problems is
to use <code>performance.now()</code>, when the browser supports it.
This function returns the elapsed times accurate to microseconds, and
it does not jump when the system time is updated from the network.</p>

<ul>
  <li><a href="http://updates.html5rocks.com/2012/08/When-milliseconds-are-not-enough-performance-now">
    http://updates.html5rocks.com/2012/08/When-milliseconds-are-not-enough-performance-now</a></li>
  <li><a href="http://ejohn.org/blog/accuracy-of-javascript-time/">
    http://ejohn.org/blog/accuracy-of-javascript-time/</a></li>
  <li><a href="http://www.sitepoint.com/javascript-fast-string-concatenation/">
    http://www.sitepoint.com/javascript-fast-string-concatenation/</a></li>
</ul>

<h3>Higher Level Languages</h3>

<p>Although the web standards were designed to support more than one
scripting language, only one language, ECMAScript (JavaScript), has
gained both <em>de facto</em> and <em>de jure</em> standardization
status.  If you want to use any other language for web development,
you've got to use a JavaScript compiler to translate from that
language to JavaScript.  Designed with performance in mind.</p>

<ul>
  <li><a href="http://coffeescript.org/">CoffeeScript</a> &mdash; The
  most popular language to transcompile to JavaScript.  This language
  primarily adds syntactic sugar to JavaScript.  It is <em>not</em> an
  optimizing compiler, but it is included in this list for
  completeness.</li>
  <li><a href="http://haxe.org/">Haxe</a> &mdash; A language with a
  multi-target optimizing compiler, with JavaScript and C++ targets
  available.  The C++ target, however does not yield code that is as
  efficient as can be achieved from handwritten C++.</a></li>
  <li>Cjs &mdash; Currently a sub-component of the Ocean Eddies Web
  Viewer, this is a very minimalistic translator that can translate
  JavaScript-like code to either C/C++ or JavaScript.</li>
</ul>

<p>Note that although the Google Closure Compiler is called
a <em>compiler</em>, it is not intended to be an <em>optimizing
compiler</em> that performs tasks such as function inlining
for <em>maximum execution performance</em>.  Rather, it is primarily
a <em>JavaScript minifier</em> that removes dead code.</p>

<h3>Additional resources</h3>

<p>The rest of the performance advice here details all the other best
practice tips.  Some of the best resources are listed near the top of
the list, and resources which only provide smaller gains are listed
near the bottom.</p>

<ol>
  <li>Great performance article written by an experienced JavaScript
  programmer and early web developer:<br />
  <a href="http://www.webreference.com/programming/javascript/jkm3/index.html">
    http://www.webreference.com/programming/javascript/jkm3/index.html</a></li>
  <li><a href="http://developer.nokia.com/community/wiki/JavaScript_Performance_Best_Practices">
    http://developer.nokia.com/community/wiki/JavaScript_Performance_Best_Practices</a></li>
  <li><a href="https://developer.yahoo.com/performance/rules.html">
    https://developer.yahoo.com/performance/rules.html</a></li>
  <li><a href="http://www.ibm.com/developerworks/library/wa-aj-jsajaxperf/index.html">
    http://www.ibm.com/developerworks/library/wa-aj-jsajaxperf/index.html</a></li>
  <li><a href="http://www.html5rocks.com/en/tutorials/canvas/performance/">
      http://www.html5rocks.com/en/tutorials/canvas/performance/</a></li>
  <li>Important root of a tree of performance-oriented links:<br />
  <a href="http://stackoverflow.com/questions/1246408/use-of-javascript-array-new-arrayn-declaration">
    http://stackoverflow.com/questions/1246408/use-of-javascript-array-new-arrayn-declaration</a></li>
  <li>ActionScript trigonometry lookup table implementation (you'll
  have to convert it to JavaScript to use it):<br />
  <a href="http://jacksondunstan.com/articles/1190">
    http://jacksondunstan.com/articles/1190</a></li>
  <li>Haxe, a language with a multi-target optimizing compiler, one
  of which targets is JavaScript:<br />
  <a href="http://en.wikipedia.org/wiki/Haxe">
    http://en.wikipedia.org/wiki/Haxe</a></li>
  <li><a href="http://stackoverflow.com/questions/18221571/haxe-compiled-code-peformance">
  http://stackoverflow.com/questions/18221571/haxe-compiled-code-peformance</a></li>
  <li><a href="http://stackoverflow.com/questions/12405471/why-does-drawimage-perform-slightly-noticeably-better-than-createpattern-in">
    http://stackoverflow.com/questions/12405471/why-does-drawimage-perform-slightly-noticeably-better-than-createpattern-in</a></li>
</ol>

<p>Thanks to the Mozilla Developer Network's WebGL page for providing
links to high performance JavaScript libraries.  The source code of
the libraries has helped me come to consensus on performance best
practices.</p>

<hr />
<!-- ________________________________________ -->

<h2><a name="scratch_notes" id="scratch_notes">
    Scratch Style Notes</a></h2>

<p>These are notes that are far less organized than the rest.</p>

<p>Note document all APIs and provide examples on basic usage
throughout.</p>

<p>Other mathematical constructs: clipping, bézier smoothing of a
polyline, pixel interpolation (bilinear, bicubic), great circle
subdivision.</p>

<p>Fixed function pipeline when graphics card is not capable of
performing general purpose non-linear computations.</p>

<p>With CSS styling, never set a foreground color without also setting
a background color.  You need to take into consideration that white
page backrounds are an <em>assumption</em>, not a <em>requirement</em>
of web browsers.</p>

<p>The most important thing to take note of GUI design in XHTML/CSS is
that all widgets must be within a FORM element, just like has been
demonstrated in the HTML 4 reference on the W3C's website.</p>

<p>Use namespaces in the JavaScript code.</p>

<p>The Ocean Eddies Web Viewer needs to have a favicon.</p>

<p>Stay away from CSS transitions.  Opt instead to provide the user
with a fast and snappy user interface.</p>

<p>Provide a section where you explain why everything in the UI is the
way it is.</p>

<p>Hardly any browsers do not support JavaScript 1.5: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference">
    https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference</a></p>

<p>My globe rendering test can sometimes crash Firefox 3.6.</p>

<p>Useful source for HTML 5 information: <br />
  <a href="http://html5center.sourceforge.net/">
    http://html5center.sourceforge.net/</a></p>

<p>Great circle distance computations:
  <a href="http://en.wikipedia.org/wiki/Great-circle_distance">
    http://en.wikipedia.org/wiki/Great-circle_distance</a></p>

<p><a href="http://www.html5canvastutorials.com/">
    http://www.html5canvastutorials.com/</a></p>

<h3>Mozilla Developer Network</h3>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Canvas">
    https://developer.mozilla.org/en-US/docs/Web/HTML/Canvas</a></p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API">
    https://developer.mozilla.org/en-US/docs/Web/API</a></p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Event">
    https://developer.mozilla.org/en-US/docs/Web/API/Event</a></p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/Reference/Events">
    https://developer.mozilla.org/en-US/docs/Web/Reference/Events</a></p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model/Determining_the_dimensions_of_elements">
    https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model/Determining_the_dimensions_of_elements</a></p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/window.requestAnimationFrame">
    https://developer.mozilla.org/en-US/docs/Web/API/window.requestAnimationFrame</a></p>

<h3>JavaScript</h3>

<p>You have to manually resize an HTML canvas to fit the window:<br />
  <a href="http://stackoverflow.com/questions/1664785/resize-html5-canvas-to-fit-window">
    http://stackoverflow.com/questions/1664785/resize-html5-canvas-to-fit-window</a></p>

<p>More info on HTML Canvas:<br />
  <a href="http://joshondesign.com/p/books/canvasdeepdive/title.html">
    http://joshondesign.com/p/books/canvasdeepdive/title.html</a></p>

<p><a href="http://en.wikipedia.org/wiki/Equirectangular_projection">
    http://en.wikipedia.org/wiki/Equirectangular_projection</a></p>

<p>Very important to note when maintaining compatibility with IE6:
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management">
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management</a></p>

<p><a href="http://stackoverflow.com/questions/10652513/html5-dynamically-create-canvas">
http://stackoverflow.com/questions/10652513/html5-dynamically-create-canvas</a></p>

<p>Possible solution to my MathML embedding problems:
  <a href="http://webdesignerwall.com/tutorials/css-elastic-videos">
    http://webdesignerwall.com/tutorials/css-elastic-videos</a></p>

<p><a href="https://developers.google.com/maps/documentation/javascript/v2/overlays?csw=1#Google_Maps_Coordinates">
    https://developers.google.com/maps/documentation/javascript/v2/overlays?csw=1#Google_Maps_Coordinates</a></p>

<p>D3.js map tutorial: <a href="http://bost.ocks.org/mike/map/">
    http://bost.ocks.org/mike/map/</a></p>

<p>Basic demonstration of using JavaScript to manipulate a form:<br />
  <a href="https://www.inkling.com/read/dummies-html-xhtml-css-all-one-andy-harris-2nd/chapter-4-5/managing-text-input-and-output">
    https://www.inkling.com/read/dummies-html-xhtml-css-all-one-andy-harris-2nd/chapter-4-5/managing-text-input-and-output</a></p>

<p><a href="http://stackoverflow.com/questions/14614702/html-combo-box-with-option-to-type-an-entry">
    http://stackoverflow.com/questions/14614702/html-combo-box-with-option-to-type-an-entry</a></p>

<p><a href="http://stackoverflow.com/questions/13987300/how-to-trigger-enter-key-press-of-textbox">
    http://stackoverflow.com/questions/13987300/how-to-trigger-enter-key-press-of-textbox</a></p>

<p><a href="http://www.scriptingmaster.com/html/versions-of-HTML.asp">
    http://www.scriptingmaster.com/html/versions-of-HTML.asp</a></p>

<p><a href="http://stackoverflow.com/questions/4002234/do-we-need-semicolon-at-the-end">
    http://stackoverflow.com/questions/4002234/do-we-need-semicolon-at-the-end</a></p>

<p><a href="http://stackoverflow.com/questions/12058381/changing-checked-attribute-of-a-checkbox-using-javascript">
    http://stackoverflow.com/questions/12058381/changing-checked-attribute-of-a-checkbox-using-javascript</a></p>

<p><a href="http://stackoverflow.com/questions/1085801/how-to-get-the-selected-value-of-dropdownlist-using-javascript">
    http://stackoverflow.com/questions/1085801/how-to-get-the-selected-value-of-dropdownlist-using-javascript</a></p>

<p><a href="http://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#JavaScript">
    http://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#JavaScript</a></p>

<h3>CSS</h3>

<p>CSS 2 Specification:<br />
  <a href="http://www.w3.org/TR/2011/REC-CSS2-20110607/">
    http://www.w3.org/TR/2011/REC-CSS2-20110607/</a></p>

<p>Flexible layouts for responsive design:<br />
  <a href="http://www.lukew.com/ff/entry.asp?1514">
    http://www.lukew.com/ff/entry.asp?1514</a></p>

<p><a href="http://stackoverflow.com/questions/8865458/how-to-align-text-vertically-center-in-div-with-css">
    http://stackoverflow.com/questions/8865458/how-to-align-text-vertically-center-in-div-with-css</a></p>

<p><a href="http://stackoverflow.com/questions/826782/css-rule-to-disable-text-selection-highlighting">
http://stackoverflow.com/questions/826782/css-rule-to-disable-text-selection-highlighting</a></p>

<p><a href="http://stackoverflow.com/questions/12449156/stick-footer-to-bottom-of-page-without-unnecessary-scroll-bars">
    http://stackoverflow.com/questions/12449156/stick-footer-to-bottom-of-page-without-unnecessary-scroll-bars</a></p>

<p><a href="http://css-tricks.com/snippets/css/clear-fix/">
    http://css-tricks.com/snippets/css/clear-fix/</a></p>

<p><a href="http://stackoverflow.com/questions/5776367/css-making-a-div-consume-all-available-space">
    http://stackoverflow.com/questions/5776367/css-making-a-div-consume-all-available-space</a></p>

<p><a href="http://www.creativebloq.com/css3/seven-things-still-missing-css-1126553">
    http://www.creativebloq.com/css3/seven-things-still-missing-css-1126553</a></p>
</body>
</html>
